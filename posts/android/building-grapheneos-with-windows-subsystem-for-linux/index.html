<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Building GrapheneOS with Windows Subsystem for Linux | A loudrxiv - A website for the academically-stunted</title><meta name=keywords content="Operating Systems,Android"><meta name=description content="Introduction This guide only mentions Arch Linux as it&rsquo;s the only good alternative to building AOSP on besides Ubuntu. It utilises Docker Desktop for the Arch Linux image as it&rsquo;s very close to stock Arch Linux instead of using tools like ArchWSL which are not very close to stock Arch Linux. Docker Desktop uses the official Arch Linux Docker image.
AOSP and GrapheneOS dependencies: Specs: At least 400GB of fast SSD (preferably NVMe) storage At least 20GB of DDR4 memory."><meta name=author content="June"><link rel=canonical href=https://akc3n.page/posts/grapheneos-wsl/><link crossorigin=anonymous href=/assets/css/stylesheet.c5277e43fde8b6dabe803dff75b3c935ba15f1a218d18c0bcbaba3460636ce74.css integrity="sha256-xSd+Q/3ottq+gD3/dbPJNboV8aIY0YwLy6ujRgY2znQ=" rel="preload stylesheet" as=style><noscript><link crossorigin=anonymous href=/css/includes/noscript.30127fa68e36d08f5dd7f9d4e717dac42e729b844672afd0fbcacb0d9e508595.css integrity="sha256-MBJ/po420I9d1/nU5xfaxC5ym4RGcq/Q+8rLDZ5QhZU=" rel="preload stylesheet" as=style></noscript><link rel=icon href=https://loudrxiv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://loudrxiv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://loudrxiv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://loudrxiv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://loudrxiv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta property="og:title" content="Building GrapheneOS with Windows Subsystem for Linux"><meta property="og:description" content="Introduction This guide only mentions Arch Linux as it&rsquo;s the only good alternative to building AOSP on besides Ubuntu. It utilises Docker Desktop for the Arch Linux image as it&rsquo;s very close to stock Arch Linux instead of using tools like ArchWSL which are not very close to stock Arch Linux. Docker Desktop uses the official Arch Linux Docker image.
AOSP and GrapheneOS dependencies: Specs: At least 400GB of fast SSD (preferably NVMe) storage At least 20GB of DDR4 memory."><meta property="og:type" content="article"><meta property="og:url" content="https://loudrxiv.github.io/posts/android/building-grapheneos-with-windows-subsystem-for-linux/"><meta property="og:image" content="https://loudrxiv.github.io/waving_snail.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-13T19:37:58-07:00"><meta property="article:modified_time" content="2023-03-01T12:49:14-05:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://loudrxiv.github.io/waving_snail.png"><meta name=twitter:title content="Building GrapheneOS with Windows Subsystem for Linux"><meta name=twitter:description content="Introduction This guide only mentions Arch Linux as it&rsquo;s the only good alternative to building AOSP on besides Ubuntu. It utilises Docker Desktop for the Arch Linux image as it&rsquo;s very close to stock Arch Linux instead of using tools like ArchWSL which are not very close to stock Arch Linux. Docker Desktop uses the official Arch Linux Docker image.
AOSP and GrapheneOS dependencies: Specs: At least 400GB of fast SSD (preferably NVMe) storage At least 20GB of DDR4 memory."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Categories","item":"https://loudrxiv.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Android","item":"https://loudrxiv.github.io/posts/android/"},{"@type":"ListItem","position":4,"name":"Building GrapheneOS with Windows Subsystem for Linux","item":"https://loudrxiv.github.io/posts/android/building-grapheneos-with-windows-subsystem-for-linux/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Building GrapheneOS with Windows Subsystem for Linux","name":"Building GrapheneOS with Windows Subsystem for Linux","description":"Introduction This guide only mentions Arch Linux as it\u0026rsquo;s the only good alternative to building AOSP on besides Ubuntu. It utilises Docker Desktop for the Arch Linux image as it\u0026rsquo;s very close to stock Arch Linux instead of using tools like ArchWSL which are not very close to stock Arch Linux. Docker Desktop uses the official Arch Linux Docker image.\nAOSP and GrapheneOS dependencies: Specs: At least 400GB of fast SSD (preferably NVMe) storage At least 20GB of DDR4 memory.","keywords":["Operating Systems","Android"],"articleBody":"Introduction This guide only mentions Arch Linux as it’s the only good alternative to building AOSP on besides Ubuntu. It utilises Docker Desktop for the Arch Linux image as it’s very close to stock Arch Linux instead of using tools like ArchWSL which are not very close to stock Arch Linux. Docker Desktop uses the official Arch Linux Docker image.\nAOSP and GrapheneOS dependencies: Specs: At least 400GB of fast SSD (preferably NVMe) storage At least 20GB of DDR4 memory. At least a quad core processor Arch deps: base-devel repo python3 python3-protobuf (python-protobuf on Arch) gpg (gnupg on Arch) libgcc (gcc-libs on Arch) binutils diffutils freetype2 ttf-liberation or any other TrueType/OpenType font ncurses5 (ncurses5-compat-libs on AUR) ncurses openssl openssh rsync unzip zip e2fsprogs OpenJDK (jdk8-openjdk or jdk11-openjdk or jdk-openjdk for 17 on Arch) jq yarn lib32-gcc-libs lib32-glibc signify Arch deps for WSLg and AOSP emulator: vulkan-swrast vulkan-icd-loader xorg-fonts-encoding xorg-server xorg-server-common sdl2 sdl libpulse WSL2 / WSLg dependencies: Windows 11 Professional (Enterprise preferred, Home will not work) Windows 11 supported hardware Intel VT-x or similar Intel VT-d or similar Up to date BIOS/UEFI Windows 11 installed with UEFI TPM 1.2 or 2.0 Initial setup: Open “Turn Windows features on or off”\nEnable:\nHyper-V Virtual Machine Platform Windows Hypervisor Platform Windows Subsystem for Linux then reboot Install the Linux kernel update package: https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi\nOpen PowerShell and update WSL: wsl --update\nSet WSL2 as the default version: wsl --set-default-version 2\nDocker Desktop setup: Install Docker Desktop: https://desktop.docker.com/win/main/amd64/Docker%20Desktop%20Installer.exe\nDuring install, install the WSL components as it says.\nOpen Docker and if asked to install wsl_update_x64.msi again, install it again.\nMake sure in Docker settings it’s using WSL backends.\nArch Linux Docker install: Using PowerShell, pull the official Arch Linux image: docker pull archlinux\nRun the image with the name archlinux-wsl to setup the base image:\ndocker run -it --name archlinux-wsl archlinux Perform the following setup commands: pacman -Syu pacman -S sudo vim EDITOR=vim visudo # uncomment wheel useradd -G wheel,users -m passwd # make a password pwconv grpconv # no output is expected # perform any extra setup yourself if you want as this is the base image exit Export the docker container’s state to a tar file: docker export --output archlinux-image-files.tar archlinux-wsl Import the container files to a drive you have more than 500GB on (can be your C drive if you have that space): wsl --import archlinux \u003cdirectory to store the files\u003e .\\archlinux-image-files.tar Verify Arch Linux is using WSL version 2: wsl -l -v\nOpen Arch Linux: wsl -d archlinux\nArch Linux post-install Root size: The default Virtual Hard Disk (.vhdx) created is only 256GB as shown by df -h. This is not enough for AOSP. We need to resize it (at this point I assume the drive you have the .vhdx file on is more than 500GB).\nShut down WSL: wsl --shutdown\nLocate the .vhdx file from step 5 above and get the absolute path.\nOpen diskpart (WINKEY + R then diskpart)\nEnter: select vdisk file=\"\"\nExpand the .vhdx file to at least 500GB: expand vdisk maximum=500000 (500GB)\nVerify it has expanded: detail vdisk\nNow we must expand it in Arch Linux.\nOpen Arch Linux\nFind the root disk (df -h)\nResize it: sudo resize2fs /dev/sdX (X being your root)\nVerify it has resized under the Size column: df -h\nwsl.conf: We need to create a wsl.conf due to:\npoor disk and network performance of NTFS \u003c-\u003e ext4 directories conflicting binaries with Windows PATH being appended to the Linux PATH poor disk and network performance of Windows binaries in WSL poor network performance of the internal DNS server and AOSP, Chromium, and Linux require strict case-sensitive filesystems. Open Arch Linux\nCreate and edit the VM’s wsl.conf:\nsudo vim /etc/wsl.conf Enter: [automount] options = \"case=dir\" [interop] appendWindowsPath = false [user] default = [network] generateResolvConf = false Save.\nEdit resolv.conf sudo vim /etc/resolv.conf\nRemove everything and enter nameserver Because we don’t have proper systemd (for resolved and resolvconf), the file gets cleared and never saves. Lock it from all modifications to save it permanently:\nsudo chattr +i /etc/resolv.conf Exit and shutdown WSL: wsl --shutdown\nCreate a system .wslconfig in your Windows user directory:\nC:\\Users\\\u003cmain user\u003e\\.wslconfig Enter: [wsl2] swap = 70G localhostForwarding = true nestedVirtualization = true guiApplications = true AOSP requires a lot of memory so create a swapfile just in case. Production builds of GrapheneOS are extremely memory intensive. Can be any size you want. Then save.\nStart up WSL and make sure you have a $DISPLAY variable: echo $DISPLAY AOSP emulator pre-configuration and nested virtualisation: Emulator can make use of nested virtualisation (KVM). Permissions are weird on WSL though and due to lack of proper systemd, require some workarounds.\nOpen Arch Linux\nAdd yourself to the kvm group.\nIn your .bashrc, append ulimit -n 1048575 as the soft limit is hardcoded 1024 and can’t be changed even though emulator requires more than 1024 file descriptors or it will crash and freak out. It also doesn’t seem to know how to ask for the hard limit of file descriptors. /etc/security/limits.conf doesn’t seem to work on WSL and systemd ignores DefaultNOFILE on WSL.\nDO NOT raise 1048575 ANY HIGHER. There is a bug with pam_limits where if the file descriptors limit is greater than or equal to sysctl fs.nr_open, it will break sudo. The default seems to be 1048576, so set it one below that. /etc/sysctl.conf is ignored on WSL so no reason to attempt to modify it.\nIf you do happen to lock yourself out from this, open a new window and run wsl -d archlinux --user root and make the proper change. Don’t ask how I know.\nIt’s possible KVM may not work still because it can’t access /dev/kvm despite being added to the kvm group, also due to weird WSL things. I just do sudo chmod 777 /dev/kvm. It doesn’t matter if it’s 777 because all files are created with a 000 umask on NTFS drives anyways since metadata isn’t included by default and is still experimental. WSL is not for security.\nIf you want to automatically set /dev/kvm to 777, you can set it as a WSL2 startup command in /etc/wsl.conf:\n[boot] command = chmod 777 /dev/kvm From this point on, you will ALWAYS need to do stuff in the actual Linux ext4 root. /home is apart of / so you should just do your stuff in ~/. DO NOT do stuff in NTFS drives (/mnt/c for example) as I mentioned above it’s extremely slow. This is the closest to a real Linux setup.\nYou can now follow https://grapheneos.org/build like you would on normal Linux exactly as-is. Building emulator yields near-bare-metal times (2 hours 46 minutes on WSL Arch Linux, 2 hours 6 minutes on bare-metal Arch Linux).\nAOSP emulator segmentation fault and poor performance You (might) need to disable the GPU (yeah, weird) to get high performance 60 FPS in the Android Virtual Device’s config.\nAssuming you built emulator successfully at this point navigate to the output, example: /home/herbcookie/grapheneos-12.1/out/target/product/emulator_x86_64 Edit config.ini\nSet hw.gpu.enabled from yes to no\nThen start emulator again. You should have high performance, extremely fluid, 60 FPS. It might also fix a possible segfault.\nIt’s possible this isn’t necessary and I suggest just trying to run emulator as-is before deciding if you need it. On my old machine (i7-8700k + NVIDIA GTX 1070) this was mandatory, but on my new machine (Ryzen 9 3900XT, NVIDIA RTX 3080) this was not needed.\nAcknowledgment Thanks and credit to author of this article:\ncommit a8d58587976f9c479f30cb4a69b032af412de70f Author: June \u003cjune@******.**\u003e Date: Sunday, May 1, 2022 Note Author of this paper is my friend, June. I do not take any credit for this. I am simply hosting it as June is no longer on GitHub. Several people have asked me for this guide since the original repo does not exist anymore.\n","wordCount":"1308","inLanguage":"en","datePublished":"2022-10-13T19:37:58-07:00","dateModified":"2023-03-01T12:49:14-05:00","author":{"@type":"Person","name":"June"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://loudrxiv.github.io/posts/android/building-grapheneos-with-windows-subsystem-for-linux/"},"publisher":{"@type":"Organization","name":"A loudrxiv - A website for the academically-stunted","logo":{"@type":"ImageObject","url":"https://loudrxiv.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script crossorigin=anonymous src=/assets/js/theme.b20f95bb4da41ef90a2610a557a7000b2649a3f47282ec571676da6fc0427200.js integrity="sha256-sg+Vu02kHvkKJhClV6cACyZJo/RyguxXFnbab8BCcgA="></script><header class=header><div id=progressBar></div><nav class=nav><div class=logo><a href=https://loudrxiv.github.io accesskey=h title="loudRxiv (Alt + H)"><img src=https://loudrxiv.github.io/snail.gif alt aria-label=logo height=30>loudRxiv</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><input id=hamburger-input type=checkbox></input>
<label id=hamburger-menu for=hamburger-input></label><div class=overlay></div><ul id=menu><li><a href=https://loudrxiv.github.io/posts/ title=Categories><span>Categories</span></a></li><li><a href=https://loudrxiv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://loudrxiv.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://loudrxiv.github.io/resources title=Resources><span>Resources</span></a></li><li><a href=https://tommytran.io/tommy.asc title=PGP><span>PGP</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://tommytran.io/tommy.crt title=S/MIME><span>S/MIME</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://loudrxiv.github.io>Home</a>&nbsp;»&nbsp;<a href=https://loudrxiv.github.io/posts/>Categories</a>&nbsp;»&nbsp;<a href=https://loudrxiv.github.io/posts/android/>Android</a></div><h1 class=post-title>Building GrapheneOS with Windows Subsystem for Linux</h1><div class=post-meta><span title='2022-10-13 19:37:58 -0700 -0700'>October 13, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1308 words&nbsp;·&nbsp;June&nbsp;|&nbsp;<a href=https://github.com/PrivSec-dev/privsec.dev/blob/main/content/posts/android/Building%20GrapheneOS%20with%20Windows%20Subsystem%20for%20Linux.md rel="noopener noreferrer">Suggest Changes</a>
&nbsp;|&nbsp;<span>Originally published at&nbsp;<a href=https://akc3n.page/posts/grapheneos-wsl/ title=https://akc3n.page/posts/grapheneos-wsl/ rel="noopener noreferrer">akc3n.page</a></span></div><div class=post-meta><span title="2023-03-01 12:49:14 -0500 -0500"><i>Last updated on March 1, 2023</i></span></div></header><div class="toc side"><details id=toc><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a><ul><li><a href=#aosp-and-grapheneos-dependencies aria-label="AOSP and GrapheneOS dependencies:">AOSP and GrapheneOS dependencies:</a><ul><li><a href=#specs aria-label=Specs:>Specs:</a></li><li><a href=#arch-deps aria-label="Arch deps:">Arch deps:</a></li><li><a href=#arch-deps-for-wslg-and-aosp-emulator aria-label="Arch deps for WSLg and AOSP emulator:">Arch deps for WSLg and AOSP emulator:</a></li></ul></li><li><a href=#wsl2--wslg-dependencies aria-label="WSL2 / WSLg dependencies:">WSL2 / WSLg dependencies:</a></li><li><a href=#initial-setup aria-label="Initial setup:">Initial setup:</a></li><li><a href=#docker-desktop-setup aria-label="Docker Desktop setup:">Docker Desktop setup:</a></li><li><a href=#arch-linux-docker-install aria-label="Arch Linux Docker install:">Arch Linux Docker install:</a></li><li><a href=#arch-linux-post-install aria-label="Arch Linux post-install">Arch Linux post-install</a><ul><li><a href=#root-size aria-label="Root size:">Root size:</a></li><li><a href=#wslconf aria-label=wsl.conf:>wsl.conf:</a></li><li><a href=#aosp-emulator-pre-configuration-and-nested-virtualisation aria-label="AOSP emulator pre-configuration and nested virtualisation:">AOSP emulator pre-configuration and nested virtualisation:</a></li><li><a href=#aosp-emulator-segmentation-fault-and-poor-performance aria-label="AOSP emulator segmentation fault and poor performance">AOSP emulator segmentation fault and poor performance</a></li></ul></li><li><a href=#acknowledgment aria-label=Acknowledgment>Acknowledgment</a><ul><li><a href=#note aria-label=Note>Note</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h1 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h1><p>This guide only mentions Arch Linux as it&rsquo;s the only good alternative to building AOSP on besides Ubuntu. It utilises Docker Desktop for the Arch Linux image as it&rsquo;s very close to stock Arch Linux instead of using tools like ArchWSL which are not very close to stock Arch Linux. Docker Desktop uses the official Arch Linux Docker image.</p><h2 id=aosp-and-grapheneos-dependencies>AOSP and GrapheneOS dependencies:<a hidden class=anchor aria-hidden=true href=#aosp-and-grapheneos-dependencies>#</a></h2><h3 id=specs>Specs:<a hidden class=anchor aria-hidden=true href=#specs>#</a></h3><ul><li>At least 400GB of fast SSD (preferably NVMe) storage</li><li>At least 20GB of DDR4 memory.</li><li>At least a quad core processor</li></ul><h3 id=arch-deps>Arch deps:<a hidden class=anchor aria-hidden=true href=#arch-deps>#</a></h3><ul><li>base-devel</li><li>repo</li><li>python3</li><li>python3-protobuf (python-protobuf on Arch)</li><li>gpg (gnupg on Arch)</li><li>libgcc (gcc-libs on Arch)</li><li>binutils</li><li>diffutils</li><li>freetype2</li><li>ttf-liberation or any other TrueType/OpenType font</li><li>ncurses5 (<a href=https://aur.archlinux.org/packages/ncurses5-compat-libs>ncurses5-compat-libs</a> on AUR)</li><li>ncurses</li><li>openssl</li><li>openssh</li><li>rsync</li><li>unzip</li><li>zip</li><li>e2fsprogs</li><li>OpenJDK (jdk8-openjdk or jdk11-openjdk or jdk-openjdk for 17 on Arch)</li><li>jq</li><li>yarn</li><li>lib32-gcc-libs</li><li>lib32-glibc</li><li>signify</li></ul><h3 id=arch-deps-for-wslg-and-aosp-emulator>Arch deps for WSLg and AOSP emulator:<a hidden class=anchor aria-hidden=true href=#arch-deps-for-wslg-and-aosp-emulator>#</a></h3><ul><li>vulkan-swrast</li><li>vulkan-icd-loader</li><li>xorg-fonts-encoding</li><li>xorg-server</li><li>xorg-server-common</li><li>sdl2</li><li>sdl</li><li>libpulse</li></ul><h2 id=wsl2--wslg-dependencies>WSL2 / WSLg dependencies:<a hidden class=anchor aria-hidden=true href=#wsl2--wslg-dependencies>#</a></h2><ul><li>Windows 11 Professional (Enterprise preferred, Home will not work)</li><li>Windows 11 supported hardware</li><li>Intel VT-x or similar</li><li>Intel VT-d or similar</li><li>Up to date BIOS/UEFI</li><li>Windows 11 installed with UEFI</li><li>TPM 1.2 or 2.0</li></ul><h2 id=initial-setup>Initial setup:<a hidden class=anchor aria-hidden=true href=#initial-setup>#</a></h2><ol><li><p>Open &ldquo;Turn Windows features on or off&rdquo;</p></li><li><p>Enable:</p></li></ol><ul><li>Hyper-V</li><li>Virtual Machine Platform</li><li>Windows Hypervisor Platform</li><li>Windows Subsystem for Linux</li><li>then reboot</li></ul><ol start=3><li><p>Install the Linux kernel update package: <a href=https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi>https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi</a></p></li><li><p>Open PowerShell and update WSL: <code>wsl --update</code></p></li><li><p>Set WSL2 as the default version: <code>wsl --set-default-version 2</code></p></li></ol><h2 id=docker-desktop-setup>Docker Desktop setup:<a hidden class=anchor aria-hidden=true href=#docker-desktop-setup>#</a></h2><ol><li><p>Install Docker Desktop: <a href=https://desktop.docker.com/win/main/amd64/Docker%20Desktop%20Installer.exe>https://desktop.docker.com/win/main/amd64/Docker%20Desktop%20Installer.exe</a></p></li><li><p>During install, install the WSL components as it says.</p></li><li><p>Open Docker and if asked to install wsl_update_x64.msi again, install it again.</p></li><li><p>Make sure in Docker settings it&rsquo;s using WSL backends.</p></li></ol><h2 id=arch-linux-docker-install>Arch Linux Docker install:<a hidden class=anchor aria-hidden=true href=#arch-linux-docker-install>#</a></h2><ol><li><p>Using PowerShell, pull the official Arch Linux image: <code>docker pull archlinux</code></p></li><li><p>Run the image with the name <code>archlinux-wsl</code> to setup the base image:</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>docker</span> <span class=n>run</span> <span class=n>-it</span> <span class=p>-</span><span class=n>-name</span> <span class=nb>archlinux-wsl</span> <span class=n>archlinux</span>
</span></span></code></pre></div><ol start=3><li>Perform the following setup commands:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pacman -Syu
</span></span><span class=line><span class=cl>pacman -S sudo vim
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>EDITOR</span><span class=o>=</span>vim visudo
</span></span><span class=line><span class=cl><span class=c1># uncomment wheel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>useradd -G wheel,users -m &lt;username&gt;
</span></span><span class=line><span class=cl>passwd &lt;username&gt;
</span></span><span class=line><span class=cl><span class=c1># make a password</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pwconv
</span></span><span class=line><span class=cl>grpconv
</span></span><span class=line><span class=cl><span class=c1># no output is expected</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># perform any extra setup yourself if you want as this is the base image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span>
</span></span></code></pre></div><ol start=4><li>Export the docker container&rsquo;s state to a tar file:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>docker</span> <span class=n>export</span> <span class=p>-</span><span class=n>-output</span> <span class=nb>archlinux-image</span><span class=n>-files</span><span class=p>.</span><span class=py>tar</span> <span class=nb>archlinux-wsl</span>
</span></span></code></pre></div><ol start=5><li>Import the container files to a drive you have more than 500GB on (can be your C drive if you have that space):</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>wsl</span> <span class=p>-</span><span class=n>-import</span> <span class=n>archlinux</span> <span class=p>&lt;</span><span class=n>directory</span> <span class=n>to</span> <span class=n>store</span> <span class=n>the</span> <span class=n>files</span><span class=p>&gt;</span> <span class=p>.\</span><span class=nb>archlinux-image</span><span class=n>-files</span><span class=p>.</span><span class=py>tar</span>
</span></span></code></pre></div><ol start=6><li><p>Verify Arch Linux is using WSL version 2: <code>wsl -l -v</code></p></li><li><p>Open Arch Linux: <code>wsl -d archlinux</code></p></li></ol><h2 id=arch-linux-post-install>Arch Linux post-install<a hidden class=anchor aria-hidden=true href=#arch-linux-post-install>#</a></h2><h3 id=root-size>Root size:<a hidden class=anchor aria-hidden=true href=#root-size>#</a></h3><p>The default Virtual Hard Disk (.vhdx) created is only 256GB as shown by <code>df -h</code>. This is not enough for AOSP. We need to resize it (at this point I assume the drive you have the .vhdx file on is more than 500GB).</p><p>Shut down WSL: <code>wsl --shutdown</code></p><ol><li><p>Locate the .vhdx file from step 5 above and get the absolute path.</p></li><li><p>Open <code>diskpart</code> (WINKEY + R then <code>diskpart</code>)</p></li><li><p>Enter: <code>select vdisk file="&lt;PathToVHDX>"</code></p></li><li><p>Expand the .vhdx file to at least 500GB: <code>expand vdisk maximum=500000</code> (500GB)</p></li><li><p>Verify it has expanded: <code>detail vdisk</code></p></li></ol><p>Now we must expand it in Arch Linux.</p><ol><li><p>Open Arch Linux</p></li><li><p>Find the root disk (<code>df -h</code>)</p></li><li><p>Resize it: <code>sudo resize2fs /dev/sdX</code> (X being your root)</p></li><li><p>Verify it has resized under the Size column: <code>df -h</code></p></li></ol><h3 id=wslconf>wsl.conf:<a hidden class=anchor aria-hidden=true href=#wslconf>#</a></h3><p>We need to create a wsl.conf due to:</p><ul><li>poor disk and network performance of NTFS &lt;-> ext4 directories</li><li>conflicting binaries with Windows PATH being appended to the Linux PATH</li><li>poor disk and network performance of Windows binaries in WSL</li><li>poor network performance of the internal DNS server</li><li>and AOSP, Chromium, and Linux require strict case-sensitive filesystems.</li></ul><ol><li><p>Open Arch Linux</p></li><li><p>Create and edit the VM&rsquo;s wsl.conf:</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim /etc/wsl.conf
</span></span></code></pre></div><ol start=3><li>Enter:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-Ini data-lang=Ini><span class=line><span class=cl><span class=k>[automount]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>options</span> <span class=o>=</span> <span class=s>&#34;case=dir&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[interop]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>appendWindowsPath</span> <span class=o>=</span> <span class=s>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[user]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>default</span> <span class=o>=</span> <span class=s>&lt;username&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[network]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>generateResolvConf</span> <span class=o>=</span> <span class=s>false</span>
</span></span></code></pre></div><p>Save.</p><ol start=4><li><p>Edit resolv.conf <code>sudo vim /etc/resolv.conf</code></p></li><li><p>Remove everything and enter <code>nameserver &lt;DNS server of your choice></code></p></li><li><p>Because we don&rsquo;t have proper systemd (for resolved and resolvconf), the file gets cleared and never saves. Lock it from all modifications to save it permanently:</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo chattr +i /etc/resolv.conf
</span></span></code></pre></div><ol start=7><li><p>Exit and shutdown WSL: <code>wsl --shutdown</code></p></li><li><p>Create a system <code>.wslconfig</code> in your Windows user directory:</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\&lt;</span><span class=n>main</span> <span class=n>user</span><span class=p>&gt;\.</span><span class=py>wslconfig</span>
</span></span></code></pre></div><ol start=9><li>Enter:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-Ini data-lang=Ini><span class=line><span class=cl><span class=k>[wsl2]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>swap</span> <span class=o>=</span> <span class=s>70G</span>
</span></span><span class=line><span class=cl><span class=na>localhostForwarding</span> <span class=o>=</span> <span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>nestedVirtualization</span> <span class=o>=</span> <span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>guiApplications</span> <span class=o>=</span> <span class=s>true</span>
</span></span></code></pre></div><p>AOSP requires a lot of memory so create a swapfile just in case. Production builds of GrapheneOS are extremely memory intensive. Can be any size you want. Then save.</p><ol start=10><li>Start up WSL and make sure you have a <code>$DISPLAY</code> variable: <code>echo $DISPLAY</code></li></ol><h3 id=aosp-emulator-pre-configuration-and-nested-virtualisation>AOSP emulator pre-configuration and nested virtualisation:<a hidden class=anchor aria-hidden=true href=#aosp-emulator-pre-configuration-and-nested-virtualisation>#</a></h3><p>Emulator can make use of nested virtualisation (KVM). Permissions are weird on WSL though and due to lack of proper systemd, require some workarounds.</p><ol><li><p>Open Arch Linux</p></li><li><p>Add yourself to the <code>kvm</code> group.</p></li><li><p>In your <code>.bashrc</code>, append <code>ulimit -n 1048575</code> as the soft limit is hardcoded <code>1024</code> and can&rsquo;t be changed even though emulator requires more than 1024 file descriptors or it will crash and freak out. It also doesn&rsquo;t seem to know how to ask for the hard limit of file descriptors. <code>/etc/security/limits.conf</code> doesn&rsquo;t seem to work on WSL and systemd ignores <code>DefaultNOFILE</code> on WSL.</p></li></ol><p><em><strong>DO NOT</strong></em> raise 1048575 ANY HIGHER. There is a bug with pam_limits where if the file descriptors limit is greater than or equal to <code>sysctl fs.nr_open</code>, it will break sudo. The default seems to be 1048576, so set it one below that. <code>/etc/sysctl.conf</code> is ignored on WSL so no reason to attempt to modify it.</p><p>If you do happen to lock yourself out from this, open a new window and run <code>wsl -d archlinux --user root</code> and make the proper change. Don&rsquo;t ask how I know.</p><p>It&rsquo;s possible KVM may not work still because it can&rsquo;t access <code>/dev/kvm</code> despite being added to the <code>kvm</code> group, also due to weird WSL things. I just do <code>sudo chmod 777 /dev/kvm</code>. It doesn&rsquo;t matter if it&rsquo;s 777 because all files are created with a 000 umask on NTFS drives anyways since metadata isn&rsquo;t included by default and is still experimental. WSL is not for security.</p><p>If you want to automatically set <code>/dev/kvm</code> to 777, you can set it as a WSL2 startup command in <code>/etc/wsl.conf</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Ini data-lang=Ini><span class=line><span class=cl><span class=k>[boot]</span>
</span></span><span class=line><span class=cl><span class=na>command</span> <span class=o>=</span> <span class=s>chmod 777 /dev/kvm</span>
</span></span></code></pre></div><p>From this point on, you will <em><strong>ALWAYS</strong></em> need to do stuff in the actual Linux ext4 root. <code>/home</code> is apart of <code>/</code> so you should just do your stuff in <code>~/</code>. DO NOT do stuff in NTFS drives (<code>/mnt/c</code> for example) as I mentioned above it&rsquo;s extremely slow. This is the closest to a real Linux setup.</p><p>You can now follow <a href=https://grapheneos.org/build>https://grapheneos.org/build</a> like you would on normal Linux exactly as-is. Building emulator yields near-bare-metal times (2 hours 46 minutes on WSL Arch Linux, 2 hours 6 minutes on bare-metal Arch Linux).</p><h3 id=aosp-emulator-segmentation-fault-and-poor-performance>AOSP emulator segmentation fault and poor performance<a hidden class=anchor aria-hidden=true href=#aosp-emulator-segmentation-fault-and-poor-performance>#</a></h3><p>You (might) need to disable the GPU (yeah, weird) to get high performance 60 FPS in the Android Virtual Device&rsquo;s config.</p><ol><li>Assuming you built emulator successfully at this point navigate to the output, example:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/home/herbcookie/grapheneos-12.1/out/target/product/emulator_x86_64
</span></span></code></pre></div><ol start=2><li><p>Edit <code>config.ini</code></p></li><li><p>Set <code>hw.gpu.enabled</code> from <code>yes</code> to <code>no</code></p></li></ol><p>Then start emulator again. You should have high performance, extremely fluid, 60 FPS. It might also fix a possible segfault.</p><p>It&rsquo;s possible this isn&rsquo;t necessary and I suggest just trying to run emulator as-is before deciding if you need it. On my old machine (i7-8700k + NVIDIA GTX 1070) this was mandatory, but on my new machine (Ryzen 9 3900XT, NVIDIA RTX 3080) this was not needed.</p><hr><h2 id=acknowledgment>Acknowledgment<a hidden class=anchor aria-hidden=true href=#acknowledgment>#</a></h2><p>Thanks and credit to author of this article:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-prolog data-lang=prolog><span class=line><span class=cl><span class=s>commit</span> <span class=s>a8d58587976f9c479f30cb4a69b032af412de70f</span>
</span></span><span class=line><span class=cl><span class=nv>Author</span><span class=s>:</span> <span class=nv>June</span> <span class=o>&lt;</span><span class=s>june@******.**&gt;</span>
</span></span><span class=line><span class=cl><span class=nv>Date</span><span class=s>:</span> <span class=nv>Sunday</span><span class=p>,</span> <span class=nv>May</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2022</span>
</span></span></code></pre></div><h3 id=note>Note<a hidden class=anchor aria-hidden=true href=#note>#</a></h3><p>Author of this paper is my friend, June. I do not take any credit for this. I am simply hosting it as June is no longer on GitHub. Several people have asked me for this guide since the original repo does not exist anymore.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://loudrxiv.github.io/tags/operating-systems/>Operating Systems</a></li><li><a href=https://loudrxiv.github.io/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://loudrxiv.github.io/posts/android/banking-applications-compatibility-with-grapheneos/><span class=title>« Prev</span><br><span>Banking Applications Compatibility with GrapheneOS</span></a>
<a class=next href=https://loudrxiv.github.io/posts/android/choosing-your-android-based-operating-system/><span class=title>Next »</span><br><span>Choosing Your Android-Based Operating System</span></a></nav></footer></article></main><footer class=footer><span><a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a></span>
<span>- Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer">Hugo</a> &
        <a href=https://github.com/Wonderfall/hugo-WonderMod/ rel=noopener>WonderMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script defer crossorigin=anonymous src=/assets/js/papermod.7ea300eda6d3653624a576fbc095ccd8a0c2977756acbe5de4114132a72cc7fa.js integrity="sha256-fqMA7abTZTYkpXb7wJXM2KDCl3dWrL5d5BFBMqcsx/o="></script></body></html>