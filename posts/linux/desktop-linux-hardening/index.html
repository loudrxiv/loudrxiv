<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Desktop Linux Hardening | A loudrxiv - A website for the academically-stunted</title><meta name=keywords content="Operating Systems,Linux,Privacy,Security"><meta name=description content="Linux is not a secure desktop operating system. However, there are steps you can take to harden it, reduce its attack surface, and improve its privacy.
Before we start&mldr;
Some of the sections will include mentions of unofficial builds of packages like linux‑hardened, lkrg‑akmod, hardened_malloc, and so on. These are not endorsements &mdash; they are merely to show that you have options to easily obtain and update these packages. Using unofficial builds of packages means adding more parties to trust, and you have to evaluate whether it is worth doing so for the potential privacy/security benefits or not."><meta name=author content="Tommy"><link rel=canonical href=https://loudrxiv.github.io/posts/linux/desktop-linux-hardening/><link crossorigin=anonymous href=/assets/css/stylesheet.c5277e43fde8b6dabe803dff75b3c935ba15f1a218d18c0bcbaba3460636ce74.css integrity="sha256-xSd+Q/3ottq+gD3/dbPJNboV8aIY0YwLy6ujRgY2znQ=" rel="preload stylesheet" as=style><noscript><link crossorigin=anonymous href=/css/includes/noscript.30127fa68e36d08f5dd7f9d4e717dac42e729b844672afd0fbcacb0d9e508595.css integrity="sha256-MBJ/po420I9d1/nU5xfaxC5ym4RGcq/Q+8rLDZ5QhZU=" rel="preload stylesheet" as=style></noscript><link rel=icon href=https://loudrxiv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://loudrxiv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://loudrxiv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://loudrxiv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://loudrxiv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta property="og:title" content="Desktop Linux Hardening"><meta property="og:description" content="Linux is not a secure desktop operating system. However, there are steps you can take to harden it, reduce its attack surface, and improve its privacy.
Before we start&mldr;
Some of the sections will include mentions of unofficial builds of packages like linux‑hardened, lkrg‑akmod, hardened_malloc, and so on. These are not endorsements &mdash; they are merely to show that you have options to easily obtain and update these packages. Using unofficial builds of packages means adding more parties to trust, and you have to evaluate whether it is worth doing so for the potential privacy/security benefits or not."><meta property="og:type" content="article"><meta property="og:url" content="https://loudrxiv.github.io/posts/linux/desktop-linux-hardening/"><meta property="og:image" content="https://loudrxiv.github.io/waving_snail.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-04T16:21:06-05:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://loudrxiv.github.io/waving_snail.png"><meta name=twitter:title content="Desktop Linux Hardening"><meta name=twitter:description content="Linux is not a secure desktop operating system. However, there are steps you can take to harden it, reduce its attack surface, and improve its privacy.
Before we start&mldr;
Some of the sections will include mentions of unofficial builds of packages like linux‑hardened, lkrg‑akmod, hardened_malloc, and so on. These are not endorsements &mdash; they are merely to show that you have options to easily obtain and update these packages. Using unofficial builds of packages means adding more parties to trust, and you have to evaluate whether it is worth doing so for the potential privacy/security benefits or not."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Categories","item":"https://loudrxiv.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Linux","item":"https://loudrxiv.github.io/posts/linux/"},{"@type":"ListItem","position":4,"name":"Desktop Linux Hardening","item":"https://loudrxiv.github.io/posts/linux/desktop-linux-hardening/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Desktop Linux Hardening","name":"Desktop Linux Hardening","description":"Linux is not a secure desktop operating system. However, there are steps you can take to harden it, reduce its attack surface, and improve its privacy.\nBefore we start\u0026hellip;\nSome of the sections will include mentions of unofficial builds of packages like linux‑hardened, lkrg‑akmod, hardened_malloc, and so on. These are not endorsements \u0026mdash; they are merely to show that you have options to easily obtain and update these packages. Using unofficial builds of packages means adding more parties to trust, and you have to evaluate whether it is worth doing so for the potential privacy/security benefits or not.","keywords":["Operating Systems","Linux","Privacy","Security"],"articleBody":"Linux is not a secure desktop operating system. However, there are steps you can take to harden it, reduce its attack surface, and improve its privacy.\nBefore we start…\nSome of the sections will include mentions of unofficial builds of packages like linux‑hardened, lkrg‑akmod, hardened_malloc, and so on. These are not endorsements — they are merely to show that you have options to easily obtain and update these packages. Using unofficial builds of packages means adding more parties to trust, and you have to evaluate whether it is worth doing so for the potential privacy/security benefits or not.\nDuring Installation Drive Encryption Most Linux distributions have an option within its installer for enabling LUKS full disk encryption. If this option isn’t set at installation time, you will have to backup your data and re-install, as encryption is applied after disk partitioning but before filesystem creation.\nEncrypted Swap Consider using encrypted swap or ZRAM instead of unencrypted swap to avoid potential security issues with sensitive data being pushed to swap space. While ZRAM can be set up post-installation, if you want to use encrypted swap, you should set it up while partitioning your drive.\nDepending on your distribution, encrypted swap may be automatically set up if you choose to encrypt your drive. Fedora uses ZRAM by default, regardless of whether you enable drive encryption or not.\nPrivacy Tweaks NetworkManager Trackability Reduction Most desktop Linux distributions including Fedora, openSUSE, Ubuntu, and so on come with NetworkManager by default to configure Ethernet and Wi-Fi settings.\nWfKe9vLwSvv7rN has detailed guide on trackability reduction with NetworkManager which I highly recommend you check out.\nIn short, if you use NetworkManager, add the following to your /etc/NetworkManager/conf.d/00-macrandomize.conf:\n[device] wifi.scan-rand-mac-address=yes [connection] wifi.cloned-mac-address=random ethernet.cloned-mac-address=random Next, disable transient hostname management by adding the following to your /etc/NetworkManager/conf.d/01-transient-hostname.conf:\n[main] hostname-mode=none Then, restart your NetworkManager service:\nsudo systemctl restart NetworkManager Finally, set your hostname to localhost:\nsudo hostnamectl hostname \"localhost\" Note that randomizing Wi-Fi MAC addresses depends on support from the Wi-Fi card firmware.\nOther Identifiers There are other system identifiers which you may wish to be careful about. You should give this some thought to see if it applies to your threat model:\nUsername Your username is used in a variety of ways across your system. Consider using generic terms like “user” rather than your actual name. Machine ID During installation a unique machine ID is generated and stored on your device. Consider setting it to a generic ID. System Counting Many Linux distributions sends some telemetry data by default to count how many systems are using their software. Consider disabling this depending on your threat model.\nThe Fedora Project offers a “countme” variable to much more accurately count unique systems accessing its mirrors without involving unique IDs. While currently disabled by default, you could add countme=false to /etc/dnf/dnf.conf in case the default changes in the future. On rpm‑ostree systems such as Fedora Silverblue and Kinoite, the countme option can be disabled by masking the rpm-ostree-countme timer.\nopenSUSE uses a unique ID to count systems, which can be disabled by deleting the /var/lib/zypp/AnonymousUniqueId file.\nZorin OS also uses a unique ID to count systems. You can opt‑out by running sudo apt purge zorin-os-census and optionally holding the package with sudo apt-mark hold zorin-os-census to avoid accidental reinstallation.\nsnapd (Snap) assigns a unique ID to your installation and uses it for telemetry. While this is generally not a problem, if your threat model calls for anonymity, you should avoid using Snap packages and uninstall snapd. Accidental reinstallation on Ubuntu can be prevented with sudo apt-mark hold snapd.\nOf course, this is a non‑exhaustive list of telemetry on different Linux distributions. If you are aware of other tracking mechanisms used by these or other distributions, feel free to make a pull request or discussion post detailing them!\nKeystroke Anonymization You could be fingerprinted based on soft biometric traits when you use the keyboard. The Kloak package could help you mitigate this threat. It is available as a .deb package from Kicksecure’s repository and an AUR package.\nWith that being said, if your threat model calls for using something like Kloak, you are probably better off just using Whonix.\nApplication Confinement Some sandboxing solutions for desktop Linux distributions do exist; however, they are not as strict as those found in macOS or ChromeOS. Software installed with distro package managers (DNF, APT, etc.) typically have no sandboxing or confinement whatsoever. Several projects which aim to tackle this problem are discussed here.\nFlatpak Flatpak aims to be a distribution-agnostic package manager for Linux. One of its main goals is to provide a universal package format which can be used in most Linux distributions. It provides some permission control. With that being said, Flatpak sandboxing is quite weak.\nYou can restrict applications further by setting Flatpak overrides. This can be done with the command line or by using Flatseal. Some sample overrides are provided by me and rusty-snake. Note that this only helps with lax high‑level default permissions and cannot solve the low‑level issues like /proc and /sys access or an insufficient seccomp blacklist.\nSome sensitive permissions of note:\n--share=network: network and internet access --socket=pulseaudio: the PulseAudio socket, grants access to all audio devices (including inputs) --device=all: access to all devices (including webcams) --talk-name=org.freedesktop.secrets: D‑Bus access to secrets stored on your keychain If an application works natively with Wayland (not running through the XWayland compatibility layer), consider revoking its access to X11 (--nosocket=x11) and the inter‑process communications (IPC) socket (--unshare=ipc) as well.\nMany Flatpak apps ship with broad filesystem permissions such as --filesystem=home and --filesystem=host. Some applications implement the Portal API, which allows a file manager to pass files to the Flatpak application (e.g. VLC) without specific filesystem access privileges. Despite this, many of them still declare --filesystem=host.\nMy strategy to deal with this is to revoke all filesystem access first, then test if an application works without it. If it does, it means the app is already using portals and no further action is needed. If it doesn’t, then I start granting permission to specific directories.\nAs odd as this may sound, you should not enable (blind) unattended updates of Flatpak packages. If you or a Flatpak frontend (app store) simply executes flatpak update -y, Flatpaks will be automatically granted any new permissions declared upstream without notifying you. Using automatic update with GNOME Software is fine, as it does not automatically update Flatpaks with permission changes and notifies the user instead.\nSnap Snap is another distribution-agnostic package manager with some sandboxing support. It is developed by Canonical and heavily promoted in Ubuntu.\nSnap packages come in two variants: classic, with no confinement, and strictly confined, where AppArmor and cgroups v1 are used to facilitate sandboxing. If a snap uses classic confinement (“classic snap”), you are better off installing an equivalent package from your distribution’s repository if possible. If your system does not have AppArmor, then you should avoid Snap entirely. Additionally, most modern systems outside of Ubuntu and its derivatives use cgroups v2 by default, so you have to set systemd.unified_cgroup_hierarchy=0 in your kernel parameters to get cgroups v1 working.\nSnap permissions can be managed via the Snap Store or Ubuntu’s custom patched GNOME Control Center.\nOne caveat with Snap packages is that you only have control over the interfaces declared in their manifests. For example, Snap has separate interfaces for audio-playback and audio-record, but some packages will only declare the legacy pulseaudio interface which grants access to both play and record audio. Likewise, some applications may work perfectly fine with Wayland, but the package maintainer may only declare the X11 interface in their manifest. For these cases, you need to reach out to the maintainer of the snap to update the manifest accordingly.\nFirejail Firejail is another method of sandboxing. As it is a large setuid binary, it has a large attack surface which increase susceptibility to privilege escalation vulnerabilities. Madaidan offers additional details on how Firejail can worsen the security of your device.\nIf you do use Firejail, Firetools can help to quickly manage application permissions and launch sandboxed applications. Note that Firetools configurations are temporary with no option to save profiles for long‑term use.\nFirejail can also confine X11 windows using Xpra or Xephr, something that Flatpak and Snap cannot do. I highly recommend checking out their documentation on X11 sandboxing.\nOne trick to launch applications with their Firejail profile is to use the sudo firecfg command. This will create a symlink /usr/local/bin/app_name_here pointing to Firejail, which will get used automatically by most .desktop files (which do not specify the absolute paths of their binaries) to use will launch the application through the symlink and have Firejail sandbox them this way. Of course, this is bypassable if you or some other applications launch the application directly from /usr/bin/app_name_here instead.\nMandatory Access Control Common Linux mandatory access control (MAC) frameworks require policy files in order to force constraints on the system. The two most notable are SELinux (used on Android and Fedora‑based distributions) and AppArmor (used on Debian‑based distributions and most openSUSE variants).\nFedora includes SELinux preconfigured with some policies to confine system daemons (background processes). You should keep it in enforcing mode.\nopenSUSE gives the choice of SELinux or AppArmor during the installation process. You should stick to the default for each variant (AppArmor for Tumbleweed and SELinux for MicroOS). openSUSE’s SELinux policies are derived from Fedora.\nArch and its derivatives often do not come with a mandatory access control system, and you must manually install and configure AppArmor.\nNote that, unlike Android, traditional desktop Linux distributions typically do not have full system Mandatory Access Control policies; only a few system daemons are actually confined.\nMaking Your Own Policies/Profiles You can make your own AppArmor profiles, SELinux policies, bubblewrap profiles, and seccomp blacklist to have better confinement of applications. This is an advanced and sometimes tedious task, but there are various projects you could use as reference:\nKicksecure’s apparmor-profile-everything Krathalan’s AppArmor profiles noatsecure’s SELinux templates Seirdy’s bubblewrap scripts Securing Linux Containers If you’re running a server, you may have heard of containers. They are more common in server environments where individual services are built to operate independently. However, you may sometimes see them on desktop systems as well, especially for development purposes.\nDocker is one of the most popular container solutions. It does not offer a proper sandbox, meaning there is a large kernel attack surface. You should follow the Docker and OCI Hardening guide to mitigate this problem. In short, there are things you can do like using rootless containers (via configuration changes or Podman), using a runtime which provides a psuedo‑kernel for each container (gVisor), and so on.\nAnother option is Kata Containers which masquerades virtual machines as containers. Each Kata container has its own kernel and is isolated from the host.\nSecurity Hardening Umask 077 On distributions besides openSUSE, consider changing the default umask for both root and regular users to 077 (symbolically, u=rwx,g=,o=). On openSUSE, a umask of 077 can break snapper and is thus not recommended.\nThe configuration for this varies per distribution, but typically it can be set in /etc/profile, /etc/bashrc, or /etc/login.defs.\nNote that, unlike on macOS, this will only change the umask for the shell. Files created by running applications will not have their permissions set to 600.\nMicrocode Updates You should make sure your system receives microcode updates to get fixes and mitigations for CPU vulnerabilities like Meltdown and Spectre.\nDebian does not ship microcode updates by default, so be sure to enable the non-free repository and install the microcode package.\nOn Arch Linux, make sure you have the intel-ucode or amd-ucode package installed.\nIf you are looking to use the GNU Guix distribution, you should absolutely use the Nonguix channel or similar to get microcode updates.\nAvoid the Linux-libre kernel at all costs, as they actively block loading binary‑only microcode.\nFirmware Updates Many hardware vendors offer firmware updates to Linux systems through the Linux Vendor Firmware Service. You can download and install updates using the following commands:\n# Update metadata fwupdmgr refresh # Download and install firmware updates fwupdmgr update Some distributions like Debian do not have fwupd installed by default, so you should check for its existence on your system and install it if needed.\nSeveral graphical frontends integrate with fwupd to offer firmware updates (GNOME Software, KDE Discover, Snap Store, GNOME Firmware, Pop!_OS Settings app). However, not all distributions offer this integration by default, so you should check your specific system and setup scheduled updates or update notifications using systemd timers or cron if needed.\nNote that fwupd, like Windows Update, supports updating the UEFI. Power loss or forced shutdown in the middle of a UEFI update can brick your system, so unattended UEFI updating is not recommended unless you have the means to recover from a corrupted UEFI (motherboard flashback functionality or EEPROM flashing tools). fwupd UEFI updates can be disabled by adding uefi_capsule to DisabledPlugins in /etc/fwupd/daemon.conf and then restarting the fwupd daemon (sudo systemctl restart fwupd). Keeping your UEFI up‑to‑date is important for security patches, so make sure to periodically revert this setting and apply updates manually or install UEFI updates via other methods supported by some motherboards.\nFirewall A firewall may be used to secure connections to your system.\nRed Hat distributions (such as Fedora) and openSUSE typically use firewalld. Red Hat maintains extensive documentation about firewalld and its graphical frontend firewall-config.\nDistributions based on Debian or Ubuntu typically use the Uncomplicated Firewall (ufw). As the name suggests, it is much less sophisticated than firewalld. One notable missing feature is the ability to apply different firewall rules for different connections (see zones in firewalld).\nYou could also set your default firewall zone to drop packets. To implement this with firewalld (with the necessary exceptions for IPv6):\nfirewall-cmd --set-default-zone=drop firewall-cmd --add-protocol=ipv6-icmp --permanent firewall-cmd --add-service=dhcpv6-client --permanent These firewalls use the netfilter framework and therefore cannot (without the help of strict mandatory access control) protect against malicious software running privileged on the system, which can insert their own routing rules that sidestep firewalld/ufw.\nThere are some per‑binary outbound firewalls such as OpenSnitch and Portmaster that you could use as well. But, just like firewalld and ufw, they are bypassable.\nIf you are using Flatpak packages, you can set an override to block network access. This is not bypassable.\nIf you are using non‑classic Snap packages on a system that supports proper confinement (both AppArmor and cgroups v1 present), you can use the Snap Store to revoke network permission. This is also not bypassable.\nKernel Hardening There are several things you can do to harden the Linux kernel, including setting appropriate kernel parameters and blacklisting unnecessary kernel modules.\nThis section extensively references Madaidan’s Linux Hardening Guide and in the interest of brevity does not repeat all the information contained there. You are strongly encouraged to read through the relevant sections of Madaidan’s guide (linked for convenience).\nRuntime Kernel Parameters (sysctl) See “2.2 Sysctl” in Madaidan’s guide.\nMadaidan recommends that you disable unprivileged user namespaces due to the significant attack surface for privilege escalation. However, some software such as Podman and LXC relies on unprivileged user namespaces. If you wish to use such software, do not disable kernel.unprivileged_userns_clone.\nIf you are using Kicksecure or Whonix, most of this hardening is included by default. If you are using Debian, you should consider morphing it into Kicksecure. On other distributions, you can copy the configuration files from Kicksecure into /etc/sysctl.d/ (but note that these configurations do not disable unprivileged user namespaces). There are also a few things in 30_security-misc.conf to keep in mind:\nThe bluetooth and btusb kernel modules are disabled. You need to comment out install bluetooth /bin/disabled-bluetooth-by-security-misc and install btusb /bin/disabled-bluetooth-by-security-misc to use Bluetooth. Apple filesystems are disabled. This is generally fine on non-Apple systems; however, if you are using an Apple device, you must check what filesystem your EFI partition uses. For example, if your EFI filesystem is HFS+, you need to comment out install hfsplus /bin/disabled-filesys-by-security-misc, otherwise your computer will not be able to boot Linux. The cdrom and sr_mod modules are merely blacklisted (can still be loaded at runtime with modprobe). If you have no intention to ever use CD‑ROM devices, they should be disabled by uncommenting the respective install lines. (More about how this works on the ArchWiki) To produce informative errors when utilising the configuration file, all 10 of the corresponding debugging scripts should be copied into /bin/. Boot Parameters See “2.3 Boot parameters” in Madaidan’s guide and Kicksecure boot parameters. If desired, formal documentation of boot parameters is available upstream.\nCopy these parameters into your bootloader’s configuration. On rpm‑ostree distributions, make sure to use rpm-ostree kargs rather than editing GRUB configuration directly.\nCPU mitigations spectre_v2=on spec_store_bypass_disable=on l1tf=full,force mds=full,nosmt tsx=off tsx_async_abort=full, mds=full,nosmt kvm.nx_huge_pages=force nosmt=force l1d_flush=on mmio_stale_data=full,nosmt Simultaneous multithreading (SMT) has been the cause of numerous hardware‑level vulnerabilities and is thus disabled here. If the option is available, you should disable SMT/“Hyper‑Threading” in your firmware as well.\nNote however that disabling SMT may have a significant performance impact — for this reason the popular linux‑hardened kernel for Arch does not disable SMT by default. Assess your own risk tolerance, and, if you choose to keep SMT enabled, simply remove all occurrences of nosmt and nosmt=force from these parameters.\nKernel slab_nomerge init_on_alloc=1 init_on_free=1 pti=on vsyscall=none page_alloc.shuffle=1 randomize_kstack_offset=on extra_latent_entropy debugfs=off oops=panic quiet loglevel=0 Kicksecure does not enforce either module.sig_enforce=1 or lockdown=confidentiality by default as they lead to a lot of hardware compatibility issues; consider enabling these if possible on your system. Additionally, mce=0 is no longer recommended.\nEntropy generation random.trust_cpu=off random.trust_bootloader=off Some implementations of the RDRAND instruction (by which the CPU offers a random number generator to the OS) have proven to be vulnerable or outright defective. RDRAND is also impossible to audit, being part of the CPU itself.\nAs a precaution for the integrity of cryptographic operations, the CPU and bootloader should not be used as credited entropy sources. Note that this change will increase boot time.\nFurther reading:\nsystemd: Random Seeds Madaidan: RDRAND Linux kernel mailing list Hacker News discussion NixOS discussion (also cites many additional sources) DMA mitigations intel_iommu=on amd_iommu=on efi=disable_early_pci_dma iommu.passthrough=0 iommu.strict=1 Direct memory access (DMA) attacks can be mitigated via IOMMU and disabling certain kernel modules. Furthermore, strict enforcement of IOMMU TLB invalidation should be applied so devices will never be able to access stale data contents.\nThese parameters do not provide comprehensive DMA protection. In early boot (before the kernel has loaded), only the system firmware can enforce IOMMU and thus provide DMA protection. A DMA attack in early boot can patch the kernel in memory to completely undermine these parameters.\nNote that disabling the busmaster bit on all PCI bridges during very early boot (efi=disable_early_pci_dma) can cause complete boot failure on certain systems with inadequate resources. Therefore, as always, ensure you have a fallback option to boot into the system whenever modifying any kernel parameters.\nFurther reading:\nIOMMU Groups, inside and out IOMMU introduction intel IOMMU driver analysis Avoiding gaps in IOMMU protection at boot Madaidan: DMA attacks Kernel Modules See “2.5.2 Blacklisting kernel modules” in Madaidan’s guide.\nOnce again, Kicksecure includes this hardening by default and provides a config file which can be used on other distros: /etc/modprobe.d/30_security-misc.conf\nThere are a few things in this config to keep in mind:\nBluetooth is disabled. Comment out the install bluetooth and install btusb lines to use Bluetooth. Thunderbolt is disabled. Comment out the install thunderbolt line to use Thunderbolt devices. Apple filesystems are disabled. While generally fine on non‑Apple systems, if you are using an Apple device you must check the filesystem of your EFI partition and comment out the relevant install line, otherwise your Linux install will not boot. For example, comment out the install hfsplus line if your ESP filesystem is HFS+. Restricting access to /proc and /sys See “2.4 hidepid” and “2.7 Restricting access to sysfs” in Madaidan’s guide.\nDisabling access to /sys without a proper whitelist will lead to various applications breaking. Developing such a whitelist will unfortunately be extremely tedious for most users. Kicksecure, and by extension Whonix, has the experimental proc-hidepid and hide-hardware-info services which do just this. From my testing, these work perfectly fine on minimal Kicksecure installations and both Qubes-Whonix-Workstation and Qubes-Whonix-Gateway.\nlinux-hardened Some distributions like Arch Linux offer the linux‑hardened kernel package. It includes hardening patches and more security-conscious defaults.\nlinux‑hardened has unprivileged user namespaces (kernel.unprivileged_userns_clone) disabled by default. This may impact some software.\nLinux Kernel Runtime Guard (LKRG) LKRG is a kernel module which self‑describes as a runtime kernel integrity checker and exploit detector:\nAs controversial as this concept is, LKRG attempts to post‑detect and hopefully promptly respond to unauthorized modifications to the running Linux kernel (integrity checking) or to credentials such as user IDs of the running processes (exploit detection). For process credentials, LKRG attempts to detect the exploit and take action before the kernel would grant access (such as open a file) based on the unauthorized credentials.\nLKRG defeats many pre-existing exploits of Linux kernel vulnerabilities, and will likely defeat many future exploits (including of yet unknown vulnerabilities) that do not specifically attempt to bypass LKRG. While LKRG is bypassable by design, such bypasses tend to require more complicated and/or less reliable exploits.\n(From LKRG - Linux Kernel Runtime Guard.)\nIf you can get LKRG and maintain module updates, it provides a worthwhile improvement to security.\nDebian-based distributions can get the LKRG DKMS package from Kicksecure, though Kicksecure does not install it by default. Packaging for Fedora is available through a Copr repository maintained by Qubes OS developer fepitre. Arch users can obtain the LKRG DKMS package from the AUR.\ngrsecurity Grsecurity offers a set of kernel patches that attempt to improve security of the Linux kernel. Payment is required, but grsecurity is worth using if you have a subscription.\nHardened Memory Allocator The hardened memory allocator (hardened_malloc) from GrapheneOS can be used on general Linux distributions, though only for some programs.\nKicksecure installs it by default (though not enabled by default) and provides in‑depth usage instructions relevant to all distributions. On Arch-based systems, hardened_malloc is available through the AUR. Divested Computing Group maintains a Fedora build.\nMountpoint Hardening Consider adding the mount options nodev, noexec, and nosuid to mountpoints which do not need the respective capabilities. Typically, these can be applied to /boot, /boot/efi, and /var. These flags could also be applied to /home and /root, however noexec will prevent applications that require binary execution in those locations from working (including Flatpak and Snap).\nIt should be noted that noexec is not foolproof and actually quite easy to bypass.\nIf you use Toolbox, do not set any of these mount options on /var/log/journal. From my testing, the Toolbox container will fail to start if you have nodev, nosuid, or noexec on said directory. If you are on Arch Linux, you probably do not want to set noexec on /var/tmp, as some AUR packages will then fail to build.\nDisabling SUID SUID allows a user to execute an application as the owner of that application, which in many cases is the root user. Vulnerable SUID executables could lead to privilege escalation vulnerabilities.\nIt is desirable to remove SUID from as many binaries as possible; however, this takes substantial effort and trial and error on the user’s part, as some applications require SUID to function.\nKicksecure, and by extension Whonix, has an experimental permission hardening service and application whitelist to automate SUID removal from most binaries and libraries on the system. From my testing, these work perfectly fine on minimal Kicksecure installations and both Qubes-Whonix-Workstation and Qubes-Whonix-Gateway.\nDNSSEC Most Linux distributions do not enable DNSSEC by default. I recommend that you enable it to make sure that the responses to your DNS queries are authentic. You will need a DNS provider that supports DNSSEC. Ideally, you should use a VPN which provides this feature with its DNS servers so that you can also blend in with other people.\nOn systems with systemd-resolved, you can edit the /etc/systemd/resolved.conf file and add DNSSEC=yes to enable it. Do systemctl restart systemd-resolved after you are done editing to apply your configuration.\nIf you are a Whonix or Tails user, you can disregard setting up DNSSEC, as Tor DNS resolution does not support it. Alternatively, you can use a non-Tor resolver, though it is not recommended that you do this for an extended amount of time.\nTime Synchronization Most Linux distributions by default use the unencrypted and unauthenticated Network Time Protocol (NTP) for time synchronization. There are two ways to easily solve this problem:\nConfigure Network Time Security (NTS) with chronyd Use Kicksecure’s sdwdate on Debian‑based distributions. If decide on using NTS with chronyd, consider using multiple, independent time providers and setting minsources greater than 1.\nGrapheneOS uses a quite nice chrony configuration for their infrastructure. I recommend that you replicate their chrony.conf on your system.\nPluggable Authentication Modules (PAM) PAM’s settings can be hardened to improve authentication security (though keep in mind the bypassable nature of PAM as opposed to encryption).\nOn Red Hat distributions, you can use authselect to configure this, e.g.:\nsudo authselect select with-faillock without-nullok with-pamaccess On systems where pam_faillock is not available, consider using pam_tally2 instead.\nIf you have a YubiKey or other U2F/FIDO2 authenticator, you can use pam-u2f to implement two‑factor authentication for login. Make sure to use a hardcoded origin and appid as indicated in the ArchWiki. Do not use the default identifier pam://$HOSTNAME which will break if your hostname changes.\nStorage Media Handling Some Linux distributions and desktop environments automatically mount arbitary filesystems upon storage media insertion. This is a security risk, as an adversary can attach a malicious storage device to your computer to exploit vulnerable filesystem drivers.\nThis behavior is disabled by default on Whonix.\nUDisks GNOME users on systems with UDisks can mitigate this risk by running the following commands:\necho '[org/gnome/desktop/media-handling] automount=false automount-open=false' | sudo tee /etc/dconf/db/local.d/automount-disable echo 'org/gnome/desktop/media-handling/automount org/gnome/desktop/media-handling/automount-open' | sudo tee /etc/dconf/db/local.d/locks/automount-disable sudo dconf update This will disable automounting and prevent users from overriding that setting (without privileges).\nCinnamon uses the same configuration/commands except with cinnamon substituted in place of gnome. Other desktop environments based on GNOME 3 likely follow a similar pattern — use gsettings to investigate.\nautofs On older systems where autofs is used, you should mask the autofs service to disable this behavior.\nUSB Port Protection To better protect your USB ports from attacks such as BadUSB and the infamous Hak5 USB Rubber Ducky, I recommend USBGuard. Documentation is available on the USBGuard website and ArchWiki.\nIf you are using linux‑hardened, you can alternatively use the deny_new_usb kernel parameter — see “Preventing USB Attacks with linux\u0026#8209;hardened”.\nSecure Boot Secure Boot can be used to secure the boot process by preventing the loading of unsigned UEFI drivers and bootloaders.\nOne of the problems with Secure Boot, particularly on Linux, is that only the chainloader (shim), bootloader (GRUB), and kernel are verified in a typical setup. The initramfs is often left unverified and unencrypted, leaving the door open for an evil maid attack.\nThe firmware on most devices is also preconfigured to trust Microsoft’s keys for both Windows and third‑parties, leading to a large attacks surface.\nEnrolling your own keys Please note that this procedure will brick some non‑compliant UEFI implementations. You should research your specific computer/motherboard, looking for reported successes and failures alike, before attempting. Ideally, you should be prepared to reprogram the EEPROM to a known‑good state if something goes catastrophically wrong. Integrated ‘BIOS flashback’ functionality may be an adequate recovery option.\nTo eliminate the need to trust the OEM’s keys, I recommend using sbctl.\nFirst, you need to boot into your firmware interface and enter Secure Boot setup mode. Then boot back into Linux and follow the instructions to generate and enroll your own keys.\nOn certain hardware, this will not work. Instead, you will need to export the public key to your EFI partition and manually import it through your firmware interface:\nopenssl x509 -in /usr/share/secureboot/keys/db/db.pem -outform DER -out /boot/efi/EFI/fedora/DB.cer Unified Kernel Image On most desktop Linux systems, it is possible to create a unified kernel image (UKI) that contains the kernel, initramfs, and microcode. This unified kernel image can then be signed with the keys created by sbctl.\nFor Fedora Workstation, you can follow Håvard Moen’s guide which covers sbctl installation, unified kernel image generation with dracut, and automatic signing with systemd‑boot.\nOn Arch, the process is very similar, though sbctl is already included in the official repositories and you will need to switch from mkinitpcio to dracut. Arch with linux‑hardened works well with sbctl, but some level of tedious pacman hooks are required for appropriately timing the re‑signing of all relevant files every time the kernel or bootloader is updated.\nIn my opinion, this is the most straightforward setup, with a lot of potential such as systemd’s future UKI plans including support for early‑boot attestation. With that being said, it does not appear to work well with specialized setups such as Fedora Silverblue/Kinoite or Ubuntu with ZSys. More testing is needed to see if they can be made to work.\nEncrypted /boot openSUSE openSUSE and its derivatives come with encrypted /boot out of the box (as part of the root partition). This setup does work, using encryption to sidestep the unverified initramfs problem.\nHowever, there are some caveats:\nopenSUSE uses LUKS1 instead of LUKS2 for encryption. GRUB supports PBKDF2 key derivation only, not Argon2 (the LUKS2 default). Some extra steps are necessary to avoid typing the encryption password twice. Though rather tedious, you could potentially improve security by: Enrolling your own Secure Boot keys Reinstalling GRUB with --no-shim-lock Signing GRUB and the kernel with your own keys Removing shim and MOK from the boot chain Setting up hooks to automate these tasks for every update Other Distributions On systems which use grub‑btrfs to mimic openSUSE (such as my old Arch setup), there are a few things to keep in mind:\nIt will be easier to use LUKS1 than LUKS2 with PBKDF2 for this setup. I have run into issues where GRUB will detect a LUKS1 partition converted to LUKS2 with PBKDF2 but not a pre‑existing LUKS2 partition. Include /boot in your root partition instead of as a seperate partition. With a seperate /boot partition, an evil maid attack can theoretically replace it with a malicious /boot partition. Unlocking the drive through a fake decryption prompt on the malicious partition will subsequently compromise the rest of the system. Enroll your own Secure Boot keys Install GRUB with the --no-shim-lock option. The full command I use on Arch is: grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB --modules=\"normal test efi_gop efi_uga search echo linux all_video gfxmenu gfxterm_background gfxterm_menu gfxterm loadenv configfile gzio part_gpt cryptodisk luks gcry_rijndael gcry_sha256 btrfs tpm\" --disable-shim-lock Sign GRUB and the kernel with your own keys Remove shim and MOK from the boot chain (if applicable) Set up hooks to automate these tasks for every update (pacman hooks for Arch) Disable the TPM from your firmware to prevent GRUB attempting measured boot, which does not work with grub-btrfs. Notes on Secure Boot After setting up Secure Boot, it is crucial that you password-protect your UEFI settings (sometimes called ‘supervisor’ or ‘administrator’ password) — otherwise an adversary can simply disable Secure Boot.\nThese recommendations can make you a little more resistant to evil maid attacks, but they do not constitute a proper verified boot process as found on Android, ChromeOS, or Windows.\n","wordCount":"5244","inLanguage":"en","datePublished":"2022-08-17T00:00:00Z","dateModified":"2023-02-04T16:21:06-05:00","author":{"@type":"Person","name":"Tommy"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://loudrxiv.github.io/posts/linux/desktop-linux-hardening/"},"publisher":{"@type":"Organization","name":"A loudrxiv - A website for the academically-stunted","logo":{"@type":"ImageObject","url":"https://loudrxiv.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script crossorigin=anonymous src=/assets/js/theme.b20f95bb4da41ef90a2610a557a7000b2649a3f47282ec571676da6fc0427200.js integrity="sha256-sg+Vu02kHvkKJhClV6cACyZJo/RyguxXFnbab8BCcgA="></script><header class=header><div id=progressBar></div><nav class=nav><div class=logo><a href=https://loudrxiv.github.io accesskey=h title="PrivSec (Alt + H)"><img src=https://loudrxiv.github.io/privsec.png alt aria-label=logo height=30>PrivSec</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><input id=hamburger-input type=checkbox></input>
<label id=hamburger-menu for=hamburger-input></label><div class=overlay></div><ul id=menu><li><a href=https://loudrxiv.github.io/posts/ title=Categories><span>Categories</span></a></li><li><a href=https://loudrxiv.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://loudrxiv.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://loudrxiv.github.io/resources title=Resources><span>Resources</span></a></li><li><a href=https://tommytran.io/tommy.asc title=PGP><span>PGP</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://tommytran.io/tommy.crt title=S/MIME><span>S/MIME</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://loudrxiv.github.io>Home</a>&nbsp;»&nbsp;<a href=https://loudrxiv.github.io/posts/>Categories</a>&nbsp;»&nbsp;<a href=https://loudrxiv.github.io/posts/linux/>Linux</a></div><h1 class=post-title>Desktop Linux Hardening</h1><div class=post-meta><span title='2022-08-17 00:00:00 +0000 UTC'>August 17, 2022</span>&nbsp;·&nbsp;25 min&nbsp;·&nbsp;5244 words&nbsp;·&nbsp;Tommy&nbsp;|&nbsp;<a href=https://github.com/PrivSec-dev/privsec.dev/blob/main/content/posts/linux/Desktop-Linux-Hardening.md rel="noopener noreferrer">Suggest Changes</a></div><div class=post-meta><span title="2023-02-04 16:21:06 -0500 -0500"><i>Last updated on February 4, 2023</i></span></div></header><div class="toc side"><details id=toc><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#during-installation aria-label="During Installation">During Installation</a><ul><li><a href=#drive-encryption aria-label="Drive Encryption">Drive Encryption</a></li><li><a href=#encrypted-swap aria-label="Encrypted Swap">Encrypted Swap</a></li></ul></li><li><a href=#privacy-tweaks aria-label="Privacy Tweaks">Privacy Tweaks</a><ul><li><a href=#networkmanager-trackability-reduction aria-label="NetworkManager Trackability Reduction">NetworkManager Trackability Reduction</a></li><li><a href=#other-identifiers aria-label="Other Identifiers">Other Identifiers</a><ul><li><a href=#system-counting aria-label="System Counting">System Counting</a></li></ul></li><li><a href=#keystroke-anonymization aria-label="Keystroke Anonymization">Keystroke Anonymization</a></li></ul></li><li><a href=#application-confinement aria-label="Application Confinement">Application Confinement</a><ul><li><a href=#flatpak aria-label=Flatpak>Flatpak</a></li><li><a href=#snap aria-label=Snap>Snap</a></li><li><a href=#firejail aria-label=Firejail>Firejail</a></li><li><a href=#mandatory-access-control aria-label="Mandatory Access Control">Mandatory Access Control</a></li><li><a href=#making-your-own-policiesprofiles aria-label="Making Your Own Policies/Profiles">Making Your Own Policies/Profiles</a></li><li><a href=#securing-linux-containers aria-label="Securing Linux Containers">Securing Linux Containers</a></li></ul></li><li><a href=#security-hardening aria-label="Security Hardening">Security Hardening</a><ul><li><a href=#umask-077 aria-label="Umask 077">Umask 077</a></li><li><a href=#microcode-updates aria-label="Microcode Updates">Microcode Updates</a></li><li><a href=#firmware-updates aria-label="Firmware Updates">Firmware Updates</a></li><li><a href=#firewall aria-label=Firewall>Firewall</a></li><li><a href=#kernel-hardening aria-label="Kernel Hardening">Kernel Hardening</a><ul><li><a href=#runtime-kernel-parameters-sysctl aria-label="Runtime Kernel Parameters (sysctl)">Runtime Kernel Parameters (sysctl)</a></li><li><a href=#boot-parameters aria-label="Boot Parameters">Boot Parameters</a><ul><li><a href=#cpu-mitigations aria-label="CPU mitigations">CPU mitigations</a></li><li><a href=#kernel aria-label=Kernel>Kernel</a></li><li><a href=#entropy-generation aria-label="Entropy generation">Entropy generation</a></li><li><a href=#dma-mitigations aria-label="DMA mitigations">DMA mitigations</a></li></ul></li><li><a href=#kernel-modules aria-label="Kernel Modules">Kernel Modules</a></li><li><a href=#restricting-access-to-proc-and-sys aria-label="Restricting access to /proc and /sys">Restricting access to /proc and /sys</a></li><li><a href=#linux-hardened aria-label=linux-hardened>linux-hardened</a></li><li><a href=#linux-kernel-runtime-guard-lkrg aria-label="Linux Kernel Runtime Guard (LKRG)">Linux Kernel Runtime Guard (LKRG)</a></li><li><a href=#grsecurity aria-label=grsecurity>grsecurity</a></li></ul></li><li><a href=#hardened-memory-allocator aria-label="Hardened Memory Allocator">Hardened Memory Allocator</a></li><li><a href=#mountpoint-hardening aria-label="Mountpoint Hardening">Mountpoint Hardening</a></li><li><a href=#disabling-suid aria-label="Disabling SUID">Disabling SUID</a></li><li><a href=#dnssec aria-label=DNSSEC>DNSSEC</a></li><li><a href=#time-synchronization aria-label="Time Synchronization">Time Synchronization</a></li><li><a href=#pluggable-authentication-modules-pam aria-label="Pluggable Authentication Modules (PAM)">Pluggable Authentication Modules (PAM)</a></li><li><a href=#storage-media-handling aria-label="Storage Media Handling">Storage Media Handling</a><ul><li><a href=#udisks aria-label=UDisks>UDisks</a></li><li><a href=#autofs aria-label=autofs>autofs</a></li></ul></li><li><a href=#usb-port-protection aria-label="USB Port Protection">USB Port Protection</a></li></ul></li><li><a href=#secure-boot aria-label="Secure Boot">Secure Boot</a><ul><li><a href=#enrolling-your-own-keys aria-label="Enrolling your own keys">Enrolling your own keys</a></li><li><a href=#unified-kernel-image aria-label="Unified Kernel Image">Unified Kernel Image</a></li><li><a href=#encrypted-boot aria-label="Encrypted /boot">Encrypted /boot</a><ul><li><a href=#opensuse aria-label=openSUSE>openSUSE</a></li><li><a href=#other-distributions aria-label="Other Distributions">Other Distributions</a></li></ul></li><li><a href=#notes-on-secure-boot aria-label="Notes on Secure Boot">Notes on Secure Boot</a></li></ul></li></ul></div></details></div><div class=post-content><p>Linux is <a href=/posts/linux/linux-insecurities/>not a secure desktop operating system</a>. However, there are steps you can take to harden it, reduce its attack surface, and improve its privacy.</p><p><strong>Before we start&mldr;</strong></p><p>Some of the sections will include mentions of unofficial builds of packages like linux‑hardened, lkrg‑akmod, hardened_malloc, and so on. These are not endorsements &mdash; they are merely to show that you have options to easily obtain and update these packages. Using unofficial builds of packages means adding more parties to trust, and you have to evaluate whether it is worth doing so for the potential privacy/security benefits or not.</p><p><img loading=lazy src=/images/fedora-tux.png alt="Fedora Tux"></p><h2 id=during-installation>During Installation<a hidden class=anchor aria-hidden=true href=#during-installation>#</a></h2><h3 id=drive-encryption>Drive Encryption<a hidden class=anchor aria-hidden=true href=#drive-encryption>#</a></h3><p>Most Linux distributions have an option within its installer for enabling LUKS full disk encryption. If this option isn&rsquo;t set at installation time, you will have to backup your data and re-install, as encryption is applied after <a href=https://en.wikipedia.org/wiki/Disk_partitioning>disk partitioning</a> but before <a href=https://en.wikipedia.org/wiki/File_system>filesystem</a> creation.</p><h3 id=encrypted-swap>Encrypted Swap<a hidden class=anchor aria-hidden=true href=#encrypted-swap>#</a></h3><p>Consider using <a href=https://wiki.archlinux.org/title/Dm-crypt/Swap_encryption>encrypted swap</a> or <a href=https://wiki.archlinux.org/title/Swap#zram-generator>ZRAM</a> instead of unencrypted swap to avoid potential security issues with sensitive data being pushed to <a href=https://en.wikipedia.org/wiki/Memory_paging>swap space</a>. While ZRAM can be set up post-installation, if you want to use encrypted swap, you should set it up while partitioning your drive.</p><p>Depending on your distribution, encrypted swap may be automatically set up if you choose to encrypt your drive. Fedora <a href=https://fedoraproject.org/wiki/Changes/SwapOnZRAM>uses ZRAM by default</a>, regardless of whether you enable drive encryption or not.</p><h2 id=privacy-tweaks>Privacy Tweaks<a hidden class=anchor aria-hidden=true href=#privacy-tweaks>#</a></h2><h3 id=networkmanager-trackability-reduction>NetworkManager Trackability Reduction<a hidden class=anchor aria-hidden=true href=#networkmanager-trackability-reduction>#</a></h3><p>Most desktop Linux distributions including Fedora, openSUSE, Ubuntu, and so on come with <a href=https://en.wikipedia.org/wiki/NetworkManager>NetworkManager</a> by default to configure Ethernet and Wi-Fi settings.</p><p>WfKe9vLwSvv7rN has detailed guide on <a href=/posts/linux/networkmanager-trackability-reduction/>trackability reduction with NetworkManager</a> which I highly recommend you check out.</p><p>In short, if you use NetworkManager, add the following to your <code>/etc/NetworkManager/conf.d/00-macrandomize.conf</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[device]
</span></span><span class=line><span class=cl>wifi.scan-rand-mac-address=yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[connection]
</span></span><span class=line><span class=cl>wifi.cloned-mac-address=random
</span></span><span class=line><span class=cl>ethernet.cloned-mac-address=random
</span></span></code></pre></div><p>Next, disable transient hostname management by adding the following to your <code>/etc/NetworkManager/conf.d/01-transient-hostname.conf</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[main]
</span></span><span class=line><span class=cl>hostname-mode=none
</span></span></code></pre></div><p>Then, restart your NetworkManager service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart NetworkManager
</span></span></code></pre></div><p>Finally, set your hostname to <code>localhost</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo hostnamectl hostname <span class=s2>&#34;localhost&#34;</span>
</span></span></code></pre></div><p>Note that randomizing Wi-Fi MAC addresses depends on support from the Wi-Fi card firmware.</p><h3 id=other-identifiers>Other Identifiers<a hidden class=anchor aria-hidden=true href=#other-identifiers>#</a></h3><p>There are other system identifiers which you may wish to be careful about. You should give this some thought to see if it applies to your <a href=/posts/knowledge/threat-modeling/>threat model</a>:</p><dl><dt>Username</dt><dd>Your username is used in a variety of ways across your system. Consider using generic terms like &ldquo;user&rdquo; rather than your actual name.</dd><dt>Machine ID</dt><dd>During installation a unique machine ID is generated and stored on your device. Consider <a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#machine-id>setting it to a generic ID</a>.</dd></dl><h4 id=system-counting>System Counting<a hidden class=anchor aria-hidden=true href=#system-counting>#</a></h4><p>Many Linux distributions sends some telemetry data by default to count how many systems are using their software. Consider disabling this depending on your threat model.</p><p>The Fedora Project offers a <a href=https://dnf.readthedocs.io/en/latest/conf_ref.html#countme-label>&ldquo;countme&rdquo; variable</a> to much more accurately <a href=https://fedoraproject.org/wiki/Changes/DNF_Better_Counting>count unique systems accessing its mirrors</a> without involving unique IDs. While currently disabled by default, you could add <code>countme=false</code> to <code>/etc/dnf/dnf.conf</code> in case the default changes in the future. On rpm‑ostree systems such as Fedora Silverblue and Kinoite, the <code>countme</code> option can be disabled by <a href=https://coreos.github.io/rpm-ostree/countme/>masking the rpm-ostree-countme timer</a>.</p><p><a href=https://en.opensuse.org/openSUSE:Statistics>openSUSE uses a unique ID to count systems</a>, which can be disabled by deleting the <code>/var/lib/zypp/AnonymousUniqueId</code> file.</p><p><a href=https://zorin.com/legal/privacy/#census>Zorin OS also uses a unique ID to count systems.</a> You can opt‑out by running <code>sudo apt purge zorin-os-census</code> and optionally holding the package with <code>sudo apt-mark hold zorin-os-census</code> to avoid accidental reinstallation.</p><p><a href=https://snapcraft.io/docs/snap-store-metrics>snapd (Snap) assigns a unique ID to your installation and uses it for telemetry.</a> While this is generally not a problem, if your threat model calls for anonymity, you should avoid using Snap packages and uninstall snapd. Accidental reinstallation on Ubuntu can be prevented with <code>sudo apt-mark hold snapd</code>.</p><p><em>Of course, this is a non‑exhaustive list of telemetry on different Linux distributions. If you are aware of other tracking mechanisms used by these or other distributions, feel free to make a <a href=https://github.com/PrivSec-dev/privsec.dev/blob/main/content/posts/linux/Linux-Desktop-Hardening.md>pull request</a> or <a href=https://github.com/PrivSec-dev/privsec.dev/discussions>discussion post</a> detailing them!</em></p><h3 id=keystroke-anonymization>Keystroke Anonymization<a hidden class=anchor aria-hidden=true href=#keystroke-anonymization>#</a></h3><p>You could be <a href=https://www.whonix.org/wiki/Keystroke_Deanonymization>fingerprinted based on soft biometric traits</a> when you use the keyboard. The <a href=https://github.com/vmonaco/kloak>Kloak</a> package could help you mitigate this threat. It is available as a .deb package from <a href=https://www.kicksecure.com/wiki/Packages_for_Debian_Hosts>Kicksecure&rsquo;s repository</a> and an <a href=https://aur.archlinux.org/packages/kloak-git>AUR package</a>.</p><p>With that being said, if your threat model calls for using something like Kloak, you are probably better off just using Whonix.</p><h2 id=application-confinement>Application Confinement<a hidden class=anchor aria-hidden=true href=#application-confinement>#</a></h2><p>Some sandboxing solutions for desktop Linux distributions do exist; however, they are not as strict as those found in macOS or ChromeOS. Software installed with distro package managers (DNF, APT, etc.) typically have <strong>no</strong> sandboxing or confinement whatsoever. Several projects which aim to tackle this problem are discussed here.</p><h3 id=flatpak>Flatpak<a hidden class=anchor aria-hidden=true href=#flatpak>#</a></h3><div class=youtube-embed-div><iframe src=https://www.youtube-nocookie.com/embed/GkgPIJp8_30 class=youtube-embed-frame allowfullscreen title="YouTube Video"></iframe></div><p><a href=https://flatpak.org>Flatpak</a> aims to be a distribution-agnostic package manager for Linux. One of its main goals is to provide a universal package format which can be used in most Linux distributions. It provides some <a href=https://docs.flatpak.org/en/latest/sandbox-permissions.html>permission control</a>. With that being said, <a href=https://madaidans-insecurities.github.io/linux.html#flatpak>Flatpak sandboxing is quite weak</a>.</p><p>You can restrict applications further by setting <a href=https://docs.flatpak.org/en/latest/flatpak-command-reference.html#flatpak-override>Flatpak overrides</a>. This can be done with the command line or by using <a href=https://github.com/tchx84/Flatseal>Flatseal</a>. Some sample overrides are provided by <a href=https://github.com/tommytran732/Flatpak-Overrides>me</a> and <a href=https://github.com/rusty-snake/kyst/tree/main/flatpak>rusty-snake</a>. Note that this only helps with lax high‑level default permissions and cannot solve the low‑level issues like <code>/proc</code> and <code>/sys</code> access or an insufficient seccomp blacklist.</p><p>Some sensitive permissions of note:</p><ul><li><code>--share=network</code>: network and internet access</li><li><code>--socket=pulseaudio</code>: the PulseAudio socket, grants access to all audio devices (including inputs)</li><li><code>--device=all</code>: access to all devices (including webcams)</li><li><code>--talk-name=org.freedesktop.secrets</code>: D‑Bus access to secrets stored on your keychain</li></ul><p>If an application works natively with Wayland (<em>not</em> running through the <a href=https://wayland.freedesktop.org/xserver.html>XWayland</a> compatibility layer), consider revoking its access to X11 (<code>--nosocket=x11</code>) and the <a href=https://en.wikipedia.org/wiki/Unix_domain_socket>inter‑process communications (IPC)</a> socket (<code>--unshare=ipc</code>) as well.</p><p>Many Flatpak apps ship with broad filesystem permissions such as <code>--filesystem=home</code> and <code>--filesystem=host</code>. Some applications implement the <a href=https://docs.flatpak.org/en/latest/portal-api-reference.html>Portal API</a>, which allows a file manager to pass files to the Flatpak application (e.g. VLC) without specific filesystem access privileges. Despite this, many of them <a href=https://github.com/flathub/org.videolan.VLC/blob/master/org.videolan.VLC.json>still declare <code>--filesystem=host</code></a>.</p><p>My strategy to deal with this is to revoke all filesystem access first, then test if an application works without it. If it does, it means the app is already using portals and no further action is needed. If it doesn&rsquo;t, then I start granting permission to specific directories.</p><p>As odd as this may sound, <strong>you should not enable (blind) unattended updates of Flatpak packages</strong>. If you or a Flatpak frontend (app store) simply executes <code>flatpak update -y</code>, Flatpaks will be automatically granted any new permissions declared upstream without notifying you. Using automatic update with GNOME Software is fine, as it does not automatically update Flatpaks with permission changes and notifies the user instead.</p><h3 id=snap>Snap<a hidden class=anchor aria-hidden=true href=#snap>#</a></h3><p>Snap is another distribution-agnostic package manager with some sandboxing support. It is developed by Canonical and heavily promoted in Ubuntu.</p><p>Snap packages come in <a href=https://snapcraft.io/docs/snap-confinement>two variants</a>: classic, with no confinement, and strictly confined, where AppArmor and cgroups v1 are used to facilitate sandboxing. If a snap uses classic confinement (&ldquo;classic snap&rdquo;), you are better off installing an equivalent package from your distribution&rsquo;s repository if possible. If your system does not have AppArmor, then you should avoid Snap entirely. Additionally, most modern systems outside of Ubuntu and its derivatives use cgroups v2 by default, so you have to set <code>systemd.unified_cgroup_hierarchy=0</code> in your kernel parameters to get cgroups v1 working.</p><p>Snap permissions can be managed via the Snap Store or Ubuntu&rsquo;s custom patched GNOME Control Center.</p><p>One caveat with Snap packages is that you only have control over the interfaces declared in their manifests. For example, Snap has separate interfaces for <code>audio-playback</code> and <code>audio-record</code>, but some packages will only declare the legacy <code>pulseaudio</code> interface which grants access to both play and record audio. Likewise, some applications may work perfectly fine with Wayland, but the package maintainer may only declare the X11 interface in their manifest. For these cases, you need to reach out to the maintainer of the snap to update the manifest accordingly.</p><h3 id=firejail>Firejail<a hidden class=anchor aria-hidden=true href=#firejail>#</a></h3><div class=youtube-embed-div><iframe src=https://www.youtube-nocookie.com/embed/N-Mso2bSr3o class=youtube-embed-frame allowfullscreen title="YouTube Video"></iframe></div><p><a href=https://firejail.wordpress.com/>Firejail</a> is another method of sandboxing. As it is a large <a href=https://en.wikipedia.org/wiki/Setuid>setuid</a> binary, it has a large attack surface which increase susceptibility to <a href=https://en.wikipedia.org/wiki/Privilege_escalation>privilege escalation vulnerabilities</a>. <a href=https://madaidans-insecurities.github.io/linux.html#firejail>Madaidan offers additional details on how Firejail can worsen the security of your device.</a></p><p>If you do use Firejail, <a href=https://github.com/netblue30/firetools>Firetools</a> can help to quickly manage application permissions and launch sandboxed applications. Note that Firetools configurations are temporary with no option to save profiles for long‑term use.</p><p>Firejail can also confine X11 windows using Xpra or Xephr, something that Flatpak and Snap cannot do. I highly recommend checking out <a href=https://firejail.wordpress.com/documentation-2/x11-guide/>their documentation on X11 sandboxing</a>.</p><p>One trick to launch applications with their Firejail profile is to use the <code>sudo firecfg</code> command. This will create a symlink <code>/usr/local/bin/app_name_here</code> pointing to Firejail, which will get used automatically by most .desktop files (which do not specify the absolute paths of their binaries) to use will launch the application through the symlink and have Firejail sandbox them this way. Of course, this is bypassable if you or some other applications launch the application directly from <code>/usr/bin/app_name_here</code> instead.</p><h3 id=mandatory-access-control>Mandatory Access Control<a hidden class=anchor aria-hidden=true href=#mandatory-access-control>#</a></h3><p>Common Linux <a href=https://en.wikipedia.org/wiki/Mandatory_access_control>mandatory access control (MAC)</a> frameworks require policy files in order to force constraints on the system. The two most notable are <a href=https://github.com/SELinuxProject/selinux>SELinux</a> (used on Android and Fedora‑based distributions) and <a href=https://gitlab.com/apparmor/apparmor>AppArmor</a> (used on Debian‑based distributions and most openSUSE variants).</p><p>Fedora includes SELinux preconfigured with some policies to confine system daemons (background processes). You should keep it in <em>enforcing</em> mode.</p><p>openSUSE gives the choice of SELinux or AppArmor during the installation process. You should stick to the default for each variant (AppArmor for <a href=https://get.opensuse.org/tumbleweed/>Tumbleweed</a> and SELinux for <a href=https://microos.opensuse.org/>MicroOS</a>). openSUSE’s SELinux policies are derived from Fedora.</p><p>Arch and its derivatives often do not come with a mandatory access control system, and you must manually install and configure <a href=https://wiki.archlinux.org/title/AppArmor>AppArmor</a>.</p><p>Note that, unlike Android, traditional desktop Linux distributions typically do not have full system Mandatory Access Control policies; only a few system daemons are actually confined.</p><h3 id=making-your-own-policiesprofiles>Making Your Own Policies/Profiles<a hidden class=anchor aria-hidden=true href=#making-your-own-policiesprofiles>#</a></h3><p>You can make your own AppArmor profiles, SELinux policies, <a href=https://github.com/containers/bubblewrap>bubblewrap</a> profiles, and <a href=https://docs.kernel.org/userspace-api/seccomp_filter.html>seccomp</a> blacklist to have better confinement of applications. This is an advanced and sometimes tedious task, but there are various projects you could use as reference:</p><ul><li><a href=https://github.com/Kicksecure/apparmor-profile-everything>Kicksecure&rsquo;s apparmor-profile-everything</a></li><li><a href=https://github.com/krathalan/apparmor-profiles>Krathalan’s AppArmor profiles</a></li><li><a href=https://github.com/noatsecure/hardhat-selinux-templates>noatsecure’s SELinux templates</a></li><li><a href=https://sr.ht/~seirdy/bwrap-scripts>Seirdy’s bubblewrap scripts</a></li></ul><h3 id=securing-linux-containers>Securing Linux Containers<a hidden class=anchor aria-hidden=true href=#securing-linux-containers>#</a></h3><p>If you’re running a server, you may have heard of containers. They are more common in server environments where individual services are built to operate independently. However, you may sometimes see them on desktop systems as well, especially for development purposes.</p><p><a href=https://www.docker.com/>Docker</a> is one of the most popular container solutions. It does <strong>not</strong> offer a proper sandbox, meaning there is a large kernel attack surface. You should follow the <a href=/posts/linux/docker-and-oci-hardening/>Docker and OCI Hardening guide</a> to mitigate this problem. In short, there are things you can do like using rootless containers (via configuration changes or <a href=https://podman.io/>Podman</a>), using a runtime which provides a psuedo‑kernel for each container (<a href=https://gvisor.dev/>gVisor</a>), and so on.</p><p>Another option is <a href=https://katacontainers.io/>Kata Containers</a> which masquerades virtual machines as containers. Each Kata container has its own kernel and is isolated from the host.</p><h2 id=security-hardening>Security Hardening<a hidden class=anchor aria-hidden=true href=#security-hardening>#</a></h2><p><img loading=lazy src=/images/opensuse-computer.jpg alt=opensuse-computer.jpg></p><h3 id=umask-077>Umask 077<a hidden class=anchor aria-hidden=true href=#umask-077>#</a></h3><p>On distributions besides openSUSE, consider changing the default <a href=https://wiki.archlinux.org/title/Umask>umask</a> for both root and regular users to <code>077</code> (symbolically, <code>u=rwx,g=,o=</code>). <em>On openSUSE, a umask of 077 can break snapper and is thus not recommended.</em></p><p>The configuration for this varies per distribution, but typically it can be set in <code>/etc/profile</code>, <code>/etc/bashrc</code>, or <code>/etc/login.defs</code>.</p><p>Note that, unlike on macOS, this will only change the umask for the shell. Files created by running applications will not have their permissions set to 600.</p><h3 id=microcode-updates>Microcode Updates<a hidden class=anchor aria-hidden=true href=#microcode-updates>#</a></h3><p>You should make sure your system receives microcode updates to get fixes and mitigations for CPU vulnerabilities like <a href=https://meltdownattack.com/>Meltdown and Spectre</a>.</p><p>Debian does not ship microcode updates by default, so be sure to <a href=https://wiki.debian.org/SourcesList>enable the non-free repository</a> and install the <code>microcode</code> package.</p><p>On Arch Linux, make sure you have the <code>intel-ucode</code> or <code>amd-ucode</code> package installed.</p><p>If you are looking to use the <a href=https://guix.gnu.org/en/download/>GNU Guix</a> distribution, you should absolutely use the <a href=https://gitlab.com/nonguix/nonguix>Nonguix channel</a> or similar to get microcode updates.</p><p>Avoid the Linux-libre kernel at all costs, as they <a href=https://www.phoronix.com/news/GNU-Linux-Libre-5.13>actively block loading binary‑only microcode</a>.</p><h3 id=firmware-updates>Firmware Updates<a hidden class=anchor aria-hidden=true href=#firmware-updates>#</a></h3><p>Many hardware vendors offer firmware updates to Linux systems through the <a href=https://fwupd.org/>Linux Vendor Firmware Service</a>. You can download and install updates using the following commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Update metadata</span>
</span></span><span class=line><span class=cl>fwupdmgr refresh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Download and install firmware updates</span>
</span></span><span class=line><span class=cl>fwupdmgr update
</span></span></code></pre></div><p>Some distributions like Debian do not have fwupd installed by default, so you should check for its existence on your system and install it if needed.</p><p>Several graphical frontends integrate with fwupd to offer firmware updates (GNOME Software, KDE Discover, Snap Store, <a href=https://gitlab.gnome.org/World/gnome-firmware>GNOME Firmware</a>, Pop!_OS Settings app). However, not all distributions offer this integration by default, so you should check your specific system and setup scheduled updates or update notifications using <a href=https://wiki.archlinux.org/title/systemd/Timers>systemd timers</a> or <a href=https://wiki.archlinux.org/title/Cron>cron</a> if needed.</p><p>Note that fwupd, like Windows Update, supports updating the UEFI. Power loss or forced shutdown in the middle of a UEFI update can brick your system, so unattended UEFI updating is not recommended unless you have the means to recover from a corrupted UEFI (motherboard flashback functionality or EEPROM flashing tools). fwupd UEFI updates can be disabled by adding <code>uefi_capsule</code> to <code>DisabledPlugins</code> in <code>/etc/fwupd/daemon.conf</code> and then restarting the fwupd daemon (<code>sudo systemctl restart fwupd</code>). <strong>Keeping your UEFI up‑to‑date is important for security patches, so make sure to periodically revert this setting and apply updates manually or install UEFI updates via other methods supported by some motherboards.</strong></p><h3 id=firewall>Firewall<a hidden class=anchor aria-hidden=true href=#firewall>#</a></h3><p>A <a href=https://en.wikipedia.org/wiki/Firewall_(computing)>firewall</a> may be used to secure connections to your system.</p><p>Red Hat distributions (such as Fedora) and openSUSE typically use <a href=https://firewalld.org/>firewalld</a>. Red Hat maintains <a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/using-and-configuring-firewalld_configuring-and-managing-networking>extensive documentation about firewalld and its graphical frontend firewall-config</a>.</p><p>Distributions based on Debian or Ubuntu typically use the <a href=https://wiki.ubuntu.com/UncomplicatedFirewall>Uncomplicated Firewall (ufw)</a>. As the name suggests, it is much less sophisticated than firewalld. One notable missing feature is the ability to apply different firewall rules for different connections (see <em>zones</em> in firewalld).</p><p>You could also set your default firewall zone to drop packets. To implement this with firewalld (with the necessary exceptions for IPv6):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>firewall-cmd --set-default-zone=drop
</span></span><span class=line><span class=cl>firewall-cmd --add-protocol=ipv6-icmp --permanent
</span></span><span class=line><span class=cl>firewall-cmd --add-service=dhcpv6-client --permanent
</span></span></code></pre></div><p>These firewalls use the <a href=https://netfilter.org/>netfilter</a> framework and therefore cannot (without the help of strict <a href=#mandatory-access-control>mandatory access control</a>) protect against malicious software running privileged on the system, which can insert their own routing rules that sidestep firewalld/ufw.</p><p>There are some per‑binary outbound firewalls such as <a href=https://github.com/evilsocket/opensnitch>OpenSnitch</a> and <a href=https://safing.io/portmaster/>Portmaster</a> that you could use as well. But, just like firewalld and ufw, they are bypassable.</p><p>If you are using Flatpak packages, you can <a href=#flatpak>set an override to block network access</a>. This is not bypassable.</p><p>If you are using non‑classic Snap packages on a system that <a href=#snap>supports proper confinement (both AppArmor and cgroups v1 present)</a>, you can use the Snap Store to revoke network permission. This is also not bypassable.</p><h3 id=kernel-hardening>Kernel Hardening<a hidden class=anchor aria-hidden=true href=#kernel-hardening>#</a></h3><p>There are several things you can do to harden the Linux kernel, including setting appropriate <a href=https://wiki.archlinux.org/title/Kernel_parameters>kernel parameters</a> and blacklisting unnecessary kernel modules.</p><p><em>This section extensively references <a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html>Madaidan&rsquo;s Linux Hardening Guide</a> and in the interest of brevity does not repeat all the information contained there. You are strongly encouraged to read through the relevant sections of Madaidan&rsquo;s guide (linked for convenience).</em></p><h4 id=runtime-kernel-parameters-sysctl>Runtime Kernel Parameters (sysctl)<a hidden class=anchor aria-hidden=true href=#runtime-kernel-parameters-sysctl>#</a></h4><p><em>See <a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#sysctl>&ldquo;2.2 Sysctl&rdquo;</a> in Madaidan&rsquo;s guide.</em></p><p>Madaidan recommends that you disable <a href=https://www.containerlabs.kubedaily.com/LXC/Linux%20Containers/User_namespaces.html>unprivileged user namespaces</a> due to the <a href=https://madaidans-insecurities.github.io/linux.html#kernel>significant attack surface for privilege escalation</a>. However, some software such as Podman and LXC relies on unprivileged user namespaces. If you wish to use such software, do not disable <code>kernel.unprivileged_userns_clone</code>.</p><p>If you are using Kicksecure or Whonix, most of this hardening is included by default. If you are using Debian, you should consider <a href=https://www.kicksecure.com/wiki/Debian>morphing it into Kicksecure</a>. On other distributions, you can copy the <a href=https://github.com/Kicksecure/security-misc/tree/master/etc/sysctl.d>configuration files from Kicksecure</a> into <code>/etc/sysctl.d/</code> (but note that these configurations do not disable unprivileged user namespaces). There are also a few things in <code>30_security-misc.conf</code> to keep in mind:</p><ul><li>The <code>bluetooth</code> and <code>btusb</code> kernel modules are disabled. You need to comment out <code>install bluetooth /bin/disabled-bluetooth-by-security-misc</code> and <code>install btusb /bin/disabled-bluetooth-by-security-misc</code> to use Bluetooth.</li><li>Apple filesystems are disabled. This is generally fine on non-Apple systems; however, if you are using an Apple device, you <strong>must</strong> check what filesystem your EFI partition uses. For example, if your EFI filesystem is HFS+, you need to comment out <code>install hfsplus /bin/disabled-filesys-by-security-misc</code>, otherwise your computer will not be able to boot Linux.</li><li>The <code>cdrom</code> and <code>sr_mod</code> modules are merely <em>blacklisted</em> (can still be loaded at runtime with <code>modprobe</code>). If you have no intention to ever use CD‑ROM devices, they should be <em>disabled</em> by <em>un</em>commenting the respective <code>install</code> lines. (<a href=https://wiki.archlinux.org/title/Kernel_module#Using_files_in_/etc/modprobe.d/_2>More about how this works on the ArchWiki</a>)</li><li>To produce informative errors when utilising the configuration file, all 10 of the corresponding <a href=https://github.com/Kicksecure/security-misc/tree/master/bin>debugging scripts</a> should be copied into <code>/bin/</code>.</li></ul><h4 id=boot-parameters>Boot Parameters<a hidden class=anchor aria-hidden=true href=#boot-parameters>#</a></h4><p><em>See <a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#boot-parameters>&ldquo;2.3 Boot parameters&rdquo;</a> in Madaidan&rsquo;s guide and <a href=https://github.com/Kicksecure/security-misc/tree/master/etc/default/grub.d>Kicksecure boot parameters</a>. If desired, <a href=https://www.kernel.org/doc/html/latest/admin-guide/kernel-parameters.html>formal documentation of boot parameters</a> is available upstream.</em></p><p>Copy these parameters into <a href=https://wiki.archlinux.org/title/Kernel_parameters#Configuration>your bootloader&rsquo;s configuration</a>. On rpm‑ostree distributions, make sure to use <code>rpm-ostree kargs</code> rather than editing GRUB configuration directly.</p><h5 id=cpu-mitigations>CPU mitigations<a hidden class=anchor aria-hidden=true href=#cpu-mitigations>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>spectre_v2=on spec_store_bypass_disable=on l1tf=full,force mds=full,nosmt tsx=off tsx_async_abort=full, mds=full,nosmt kvm.nx_huge_pages=force nosmt=force l1d_flush=on mmio_stale_data=full,nosmt
</span></span></code></pre></div><p><a href=https://en.wikipedia.org/wiki/Simultaneous_multithreading>Simultaneous multithreading (SMT)</a> has been the cause of numerous hardware‑level vulnerabilities and is thus disabled here. If the option is available, you should disable SMT/&ldquo;Hyper‑Threading&rdquo; in your firmware as well.</p><p>Note however that disabling SMT may have a significant performance impact &mdash; <a href=https://github.com/anthraxx/linux-hardened/issues/37#issuecomment-619597365>for this reason the popular linux‑hardened kernel for Arch does not disable SMT</a> by default. Assess your own risk tolerance, and, if you choose to keep SMT enabled, simply remove all occurrences of <code>nosmt</code> and <code>nosmt=force</code> from these parameters.</p><h5 id=kernel>Kernel<a hidden class=anchor aria-hidden=true href=#kernel>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>slab_nomerge init_on_alloc=1 init_on_free=1 pti=on vsyscall=none page_alloc.shuffle=1 randomize_kstack_offset=on extra_latent_entropy debugfs=off oops=panic quiet loglevel=0
</span></span></code></pre></div><p>Kicksecure does not enforce either <code>module.sig_enforce=1</code> or <code>lockdown=confidentiality</code> by default as they lead to a lot of hardware compatibility issues; consider enabling these if possible on your system. Additionally, <a href=https://forums.whonix.org/t/kernel-hardening/7296/493><code>mce=0</code> is no longer recommended</a>.</p><h5 id=entropy-generation>Entropy generation<a hidden class=anchor aria-hidden=true href=#entropy-generation>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>random.trust_cpu=off random.trust_bootloader=off
</span></span></code></pre></div><p>Some implementations of the RDRAND instruction (by which the CPU offers a random number generator to the OS) have proven to be <a href=https://en.wikipedia.org/wiki/RDRAND#Security_issues>vulnerable</a> or <a href=https://arstechnica.com/gadgets/2019/10/how-a-months-old-amd-microcode-bug-destroyed-my-weekend/>outright defective</a>. RDRAND is also impossible to audit, being part of the CPU itself.</p><p>As a precaution for the integrity of cryptographic operations, the CPU and bootloader should not be used as <em>credited</em> entropy sources. Note that this change will increase boot time.</p><p>Further reading:</p><ul><li><a href=https://systemd.io/RANDOM_SEEDS/>systemd: Random Seeds</a></li><li><a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#rdrand>Madaidan: RDRAND</a></li><li><a href=https://lore.kernel.org/lkml/20220605171539.417872-1-Jason@zx2c4.com/T/>Linux kernel mailing list</a></li><li><a href="https://news.ycombinator.com/item?id=33223232">Hacker News discussion</a></li><li><a href=https://github.com/NixOS/nixpkgs/pull/165355>NixOS discussion</a> (also cites many additional sources)</li></ul><h5 id=dma-mitigations>DMA mitigations<a hidden class=anchor aria-hidden=true href=#dma-mitigations>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>intel_iommu=on amd_iommu=on efi=disable_early_pci_dma iommu.passthrough=0 iommu.strict=1
</span></span></code></pre></div><p><a href=https://en.wikipedia.org/wiki/DMA_attack>Direct memory access (DMA) attacks</a> can be mitigated via IOMMU and <a href=#kernel-modules>disabling certain kernel modules</a>. Furthermore, <a href=https://github.com/Kicksecure/security-misc/blob/master/etc/default/grub.d/40_enable_iommu.cfg>strict enforcement of IOMMU TLB invalidation</a> should be applied so devices will never be able to access stale data contents.</p><p><a href=https://github.com/PrivSec-dev/privsec.dev/pull/81#issuecomment-1367511126>These parameters <strong>do not provide comprehensive DMA protection</strong>.</a> In early boot (before the kernel has loaded), only the system firmware can enforce IOMMU and thus provide DMA protection. A DMA attack in early boot can patch the kernel in memory to completely undermine these parameters.</p><p><em>Note that disabling the busmaster bit on all PCI bridges during very early boot (<code>efi=disable_early_pci_dma</code>) can cause complete boot failure on certain systems with inadequate resources. Therefore, as always, ensure you have a fallback option to boot into the system whenever modifying any kernel parameters.</em></p><p>Further reading:</p><ul><li><a href=https://vfio.blogspot.com/2014/08/iommu-groups-inside-and-out.html>IOMMU Groups, inside and out</a></li><li><a href=https://terenceli.github.io/%E6%8A%80%E6%9C%AF/2019/08/04/iommu-introduction>IOMMU introduction</a></li><li><a href=https://terenceli.github.io/%E6%8A%80%E6%9C%AF/2019/08/10/iommu-driver-analysis>intel IOMMU driver analysis</a></li><li><a href=https://mjg59.dreamwidth.org/54433.html>Avoiding gaps in IOMMU protection at boot</a></li><li><a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#dma-attacks>Madaidan: DMA attacks</a></li></ul><h4 id=kernel-modules>Kernel Modules<a hidden class=anchor aria-hidden=true href=#kernel-modules>#</a></h4><p><em>See <a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#kasr-kernel-modules>&ldquo;2.5.2 Blacklisting kernel modules&rdquo;</a> in Madaidan&rsquo;s guide.</em></p><p>Once again, Kicksecure includes this hardening by default and provides a config file which can be used on other distros: <a href=https://github.com/Kicksecure/security-misc/blob/master/etc/modprobe.d/30_security-misc.conf><code>/etc/modprobe.d/30_security-misc.conf</code></a></p><p>There are a few things in this config to keep in mind:</p><ul><li>Bluetooth is disabled. Comment out the <code>install bluetooth</code> and <code>install btusb</code> lines to use Bluetooth.</li><li>Thunderbolt is disabled. Comment out the <code>install thunderbolt</code> line to use Thunderbolt devices.</li><li>Apple filesystems are disabled. While generally fine on non‑Apple systems, if you are using an Apple device you <strong>must</strong> check the filesystem of your EFI partition and comment out the relevant <code>install</code> line, otherwise your Linux install will not boot. For example, comment out the <code>install hfsplus</code> line if your ESP filesystem is HFS+.</li></ul><h4 id=restricting-access-to-proc-and-sys>Restricting access to /proc and /sys<a hidden class=anchor aria-hidden=true href=#restricting-access-to-proc-and-sys>#</a></h4><p><em>See <a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#hidepid>&ldquo;2.4 hidepid&rdquo;</a> and <a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#restricting-sysfs>&ldquo;2.7 Restricting access to sysfs&rdquo;</a> in Madaidan&rsquo;s guide.</em></p><p>Disabling access to <code>/sys</code> without a proper whitelist will lead to various applications breaking. Developing such a whitelist will unfortunately be extremely tedious for most users. Kicksecure, and by extension Whonix, has the experimental <a href=https://github.com/Kicksecure/security-misc/blob/master/lib/systemd/system/proc-hidepid.service>proc-hidepid</a> and <a href=https://github.com/Kicksecure/security-misc/blob/master/lib/systemd/system/hide-hardware-info.service>hide-hardware-info</a> services which do just this. From my testing, these work perfectly fine on minimal Kicksecure installations and both Qubes-Whonix-Workstation and Qubes-Whonix-Gateway.</p><h4 id=linux-hardened>linux-hardened<a hidden class=anchor aria-hidden=true href=#linux-hardened>#</a></h4><p>Some distributions like Arch Linux offer the <a href=https://github.com/anthraxx/linux-hardened>linux‑hardened</a> kernel package. It includes <a href=https://wiki.archlinux.org/title/security#Kernel_hardening>hardening patches</a> and more security-conscious defaults.</p><p>linux‑hardened has unprivileged user namespaces (<code>kernel.unprivileged_userns_clone</code>) disabled by default. <a href=#runtime-kernel-parameters-sysctl>This may impact some software.</a></p><h4 id=linux-kernel-runtime-guard-lkrg>Linux Kernel Runtime Guard (LKRG)<a hidden class=anchor aria-hidden=true href=#linux-kernel-runtime-guard-lkrg>#</a></h4><p>LKRG is a kernel module which self‑describes as a runtime kernel integrity checker and exploit detector:</p><blockquote><p>As controversial as this concept is, LKRG attempts to <em>post</em>‑detect and <em>hopefully</em> promptly respond to unauthorized modifications to the running Linux kernel (integrity checking) or to credentials such as user IDs of the running processes (exploit detection). For process credentials, LKRG attempts to detect the exploit and take action before the kernel would grant access (such as open a file) based on the unauthorized credentials.</p><p>LKRG defeats many pre-existing exploits of Linux kernel vulnerabilities, and will likely defeat many future exploits (including of yet unknown vulnerabilities) that do not specifically attempt to bypass LKRG. While LKRG is <em>bypassable by design</em>, such bypasses tend to require more complicated and/or less reliable exploits.</p></blockquote><p><em>(From <a href=https://lkrg.org>LKRG - Linux Kernel Runtime Guard</a>.)</em></p><p>If you can get LKRG and maintain module updates, it provides a worthwhile improvement to security.</p><p>Debian-based distributions can get the LKRG DKMS package <a href=https://www.kicksecure.com/wiki/Linux_Kernel_Runtime_Guard_LKRG>from Kicksecure</a>, though Kicksecure does not install it by default. Packaging for Fedora is available through a <a href=https://copr.fedorainfracloud.org/coprs/fepitre/lkrg/>Copr repository</a> maintained by Qubes OS developer fepitre. Arch users can obtain the LKRG DKMS package <a href=https://aur.archlinux.org/packages/lkrg-dkms>from the AUR</a>.</p><h4 id=grsecurity>grsecurity<a hidden class=anchor aria-hidden=true href=#grsecurity>#</a></h4><p><a href=https://grsecurity.net/>Grsecurity</a> offers a set of kernel patches that attempt to improve security of the Linux kernel. Payment is required, but grsecurity is worth using if you have a subscription.</p><h3 id=hardened-memory-allocator>Hardened Memory Allocator<a hidden class=anchor aria-hidden=true href=#hardened-memory-allocator>#</a></h3><p>The <a href=https://github.com/GrapheneOS/hardened_malloc>hardened memory allocator (hardened_malloc)</a> from GrapheneOS can be used on general Linux distributions, though <a href=https://www.kicksecure.com/wiki/Hardened_Malloc>only for some programs</a>.</p><p>Kicksecure installs it by default (though not enabled by default) and provides <a href=https://www.kicksecure.com/wiki/Hardened_Malloc>in‑depth usage instructions</a> relevant to all distributions. On Arch-based systems, hardened_malloc is <a href=https://wiki.archlinux.org/title/Security#Hardened_malloc>available through the AUR</a>. Divested Computing Group maintains a <a href=https://github.com/divestedcg/rpm-hardened_malloc>Fedora build</a>.</p><h3 id=mountpoint-hardening>Mountpoint Hardening<a hidden class=anchor aria-hidden=true href=#mountpoint-hardening>#</a></h3><p>Consider adding the <a href=https://man7.org/linux/man-pages/man8/mount.8.html#FILESYSTEM-INDEPENDENT_MOUNT_OPTIONS>mount options</a> <code>nodev</code>, <code>noexec</code>, and <code>nosuid</code> to mountpoints which do not need the respective capabilities. Typically, these can be applied to <code>/boot</code>, <code>/boot/efi</code>, and <code>/var</code>. These flags could also be applied to <code>/home</code> and <code>/root</code>, however <code>noexec</code> will prevent applications that require binary execution in those locations from working (including Flatpak and Snap).</p><p>It should be noted that <code>noexec</code> is not foolproof and actually <a href=https://chromium.googlesource.com/chromiumos/docs/+/HEAD/security/noexec_shell_scripts.md#what-about-interpreted-code>quite easy to bypass</a>.</p><p>If you use <a href=https://docs.fedoraproject.org/en-US/fedora-silverblue/toolbox/>Toolbox</a>, do not set any of these mount options on <code>/var/log/journal</code>. From my testing, the Toolbox container will fail to start if you have <code>nodev</code>, <code>nosuid</code>, or <code>noexec</code> on said directory. If you are on Arch Linux, you probably do not want to set <code>noexec</code> on <code>/var/tmp</code>, as some AUR packages will then fail to build.</p><h3 id=disabling-suid>Disabling SUID<a hidden class=anchor aria-hidden=true href=#disabling-suid>#</a></h3><p>SUID allows a user to execute an application as the owner of that application, which in many cases is the <code>root</code> user. Vulnerable SUID executables could lead to privilege escalation vulnerabilities.</p><p>It is desirable to remove SUID from as many binaries as possible; however, this takes substantial effort and trial and error on the user&rsquo;s part, as some applications require SUID to function.</p><p>Kicksecure, and by extension Whonix, has an experimental <a href=https://github.com/Kicksecure/security-misc/blob/master/lib/systemd/system/permission-hardening.service>permission hardening service</a> and <a href=https://github.com/Kicksecure/security-misc/tree/master/etc/permission-hardening.d>application whitelist</a> to automate SUID removal from most binaries and libraries on the system. From my testing, these work perfectly fine on minimal Kicksecure installations and both Qubes-Whonix-Workstation and Qubes-Whonix-Gateway.</p><h3 id=dnssec>DNSSEC<a hidden class=anchor aria-hidden=true href=#dnssec>#</a></h3><p>Most Linux distributions do not enable <a href=https://www.icann.org/resources/pages/dnssec-what-is-it-why-important-2019-03-05-en>DNSSEC</a> by default. I recommend that you enable it to make sure that the responses to your DNS queries are authentic. You will need a DNS provider that supports DNSSEC. Ideally, you should use a VPN which provides this feature with its DNS servers so that you can also blend in with other people.</p><p>On systems with <code>systemd-resolved</code>, you can edit the <code>/etc/systemd/resolved.conf</code> file and add <code>DNSSEC=yes</code> to enable it. Do <code>systemctl restart systemd-resolved</code> after you are done editing to apply your configuration.</p><p>If you are a Whonix or Tails user, you can disregard setting up DNSSEC, as Tor DNS resolution does not support it. Alternatively, you can <a href=https://www.whonix.org/wiki/Alternative_DNS_Resolver>use a non-Tor resolver</a>, though it is not recommended that you do this for an extended amount of time.</p><h3 id=time-synchronization>Time Synchronization<a hidden class=anchor aria-hidden=true href=#time-synchronization>#</a></h3><p>Most Linux distributions by default use the unencrypted and unauthenticated <a href=https://en.wikipedia.org/wiki/Network_Time_Protocol>Network Time Protocol (NTP)</a> for time synchronization. There are two ways to easily solve this problem:</p><ul><li><a href=https://fedoramagazine.org/secure-ntp-with-nts/>Configure Network Time Security (NTS) with chronyd</a></li><li>Use Kicksecure&rsquo;s <a href=https://github.com/Kicksecure/sdwdate>sdwdate</a> on Debian‑based distributions.</li></ul><p>If decide on using NTS with chronyd, consider using multiple, independent time providers and setting <a href=https://chrony.tuxfamily.org/doc/devel/chrony.conf#minsources><code>minsources</code></a> greater than 1.</p><p>GrapheneOS uses a <a href=https://github.com/GrapheneOS/infrastructure/blob/main/chrony.conf>quite nice chrony configuration</a> for their infrastructure. I recommend that you replicate their <code>chrony.conf</code> on your system.</p><h3 id=pluggable-authentication-modules-pam>Pluggable Authentication Modules (PAM)<a hidden class=anchor aria-hidden=true href=#pluggable-authentication-modules-pam>#</a></h3><p><a href=https://wiki.archlinux.org/title/PAM>PAM</a>&rsquo;s <a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#pam>settings can be hardened</a> to improve authentication security (though keep in mind the bypassable nature of PAM as opposed to encryption).</p><p>On Red Hat distributions, you can use <a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_authentication_and_authorization_in_rhel/configuring-user-authentication-using-authselect_configuring-authentication-and-authorization-in-rhel>authselect</a> to configure this, e.g.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo authselect select &lt;profile_id, default: sssd&gt; with-faillock without-nullok with-pamaccess
</span></span></code></pre></div><p>On systems where <code>pam_faillock</code> is not available, consider using <a href=https://www.man7.org/linux/man-pages/man8/pam_tally2.8.html><code>pam_tally2</code></a> instead.</p><p>If you have a YubiKey or other U2F/FIDO2 authenticator, you can use <a href=https://github.com/Yubico/pam-u2f>pam-u2f</a> to implement two‑factor authentication for login. <strong>Make sure to use a hardcoded <code>origin</code> and <code>appid</code> as <a href=https://wiki.archlinux.org/title/Universal_2nd_Factor#Authentication_for_Arch_Linux>indicated in the ArchWiki</a>. Do not use the default identifier <code>pam://$HOSTNAME</code> which will break if your hostname changes.</strong></p><h3 id=storage-media-handling>Storage Media Handling<a hidden class=anchor aria-hidden=true href=#storage-media-handling>#</a></h3><p>Some Linux distributions and desktop environments automatically mount arbitary filesystems upon storage media insertion. This is a security risk, as an adversary can attach a malicious storage device to your computer to exploit vulnerable filesystem drivers.</p><p><em>This behavior is disabled by default on Whonix.</em></p><h4 id=udisks>UDisks<a hidden class=anchor aria-hidden=true href=#udisks>#</a></h4><p>GNOME users on systems with UDisks can mitigate this risk by running the following commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;[org/gnome/desktop/media-handling]
</span></span></span><span class=line><span class=cl><span class=s1>automount=false
</span></span></span><span class=line><span class=cl><span class=s1>automount-open=false&#39;</span> <span class=p>|</span> sudo tee /etc/dconf/db/local.d/automount-disable
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;org/gnome/desktop/media-handling/automount
</span></span></span><span class=line><span class=cl><span class=s1>org/gnome/desktop/media-handling/automount-open&#39;</span> <span class=p>|</span> sudo tee /etc/dconf/db/local.d/locks/automount-disable
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo dconf update
</span></span></code></pre></div><p>This will disable automounting and prevent users from overriding that setting (without privileges).</p><p><em>Cinnamon uses the same configuration/commands except with <code>cinnamon</code> substituted in place of <code>gnome</code>. Other desktop environments based on GNOME 3 likely follow a similar pattern &mdash; use <code>gsettings</code> to investigate.</em></p><h4 id=autofs>autofs<a hidden class=anchor aria-hidden=true href=#autofs>#</a></h4><p>On older systems where <code>autofs</code> is used, you should mask the <code>autofs</code> service to disable this behavior.</p><h3 id=usb-port-protection>USB Port Protection<a hidden class=anchor aria-hidden=true href=#usb-port-protection>#</a></h3><p>To better protect your USB ports from attacks such as <a href=https://www.srlabs.de/bites/usb-peripherals-turn>BadUSB</a> and the infamous <a href=https://hak5.org/products/usb-rubber-ducky>Hak5 USB Rubber Ducky</a>, I recommend <a href=https://usbguard.github.io>USBGuard</a>. Documentation is available on the <a href=https://usbguard.github.io>USBGuard website</a> and <a href=https://wiki.archlinux.org/title/USBGuard>ArchWiki</a>.</p><p>If you are using <a href=#linux-hardened>linux‑hardened</a>, you can alternatively use the <code>deny_new_usb</code> kernel parameter &mdash; see <a href=https://blog.lizzie.io/preventing-usb-attacks-with-linux-hardened.html>&ldquo;Preventing USB Attacks with <code>linux&amp;#8209;hardened</code>&rdquo;</a>.</p><h2 id=secure-boot>Secure Boot<a hidden class=anchor aria-hidden=true href=#secure-boot>#</a></h2><p><a href=https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface#Secure_Boot>Secure Boot</a> can be used to secure the boot process by preventing the loading of unsigned UEFI drivers and bootloaders.</p><p>One of the problems with Secure Boot, particularly on Linux, is that <a href=https://wiki.ubuntu.com/UEFI/SecureBoot#How_UEFI_Secure_Boot_works_on_Ubuntu>only the chainloader (shim), bootloader (GRUB), and kernel are verified in a typical setup</a>. The <a href=https://wiki.ubuntu.com/Initramfs#Detailed_Description>initramfs</a> is often left unverified and unencrypted, leaving the door open for an <a href=https://en.wikipedia.org/wiki/Evil_maid_attack>evil maid attack</a>.</p><p>The firmware on most devices is also preconfigured to trust Microsoft&rsquo;s keys for both Windows and third‑parties, leading to a <a href=https://github.com/ventoy/Ventoy/issues/135>large attacks surface</a>.</p><h3 id=enrolling-your-own-keys>Enrolling your own keys<a hidden class=anchor aria-hidden=true href=#enrolling-your-own-keys>#</a></h3><hr><p><em><strong>Please note that this procedure <a href=https://forums.lenovo.com/t5/Other-Linux-Discussions/Reports-of-custom-secure-boot-keys-bricking-recent-X-P-and-T-series-laptops/m-p/5105571>will brick some non‑compliant UEFI implementations</a>.</strong> You should research your specific computer/motherboard, looking for reported successes and failures alike, before attempting. Ideally, you should be prepared to reprogram the EEPROM to a known‑good state if something goes catastrophically wrong. Integrated &lsquo;BIOS flashback&rsquo; functionality may be an adequate recovery option.</em></p><hr><p>To eliminate the need to trust the OEM&rsquo;s keys, I recommend using <a href=https://github.com/Foxboron/sbctl>sbctl</a>.</p><p>First, you need to boot into your firmware interface and enter Secure Boot setup mode. Then boot back into Linux and <a href=https://github.com/Foxboron/sbctl/blob/master/README.md#key-creation-and-enrollment>follow the instructions</a> to generate and enroll your own keys.</p><p>On certain hardware, this will not work. Instead, you will need to export the public key to your EFI partition and manually import it through your firmware interface:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>openssl x509 -in /usr/share/secureboot/keys/db/db.pem -outform DER -out /boot/efi/EFI/fedora/DB.cer
</span></span></code></pre></div><h3 id=unified-kernel-image>Unified Kernel Image<a hidden class=anchor aria-hidden=true href=#unified-kernel-image>#</a></h3><p>On most desktop Linux systems, it is possible to create a <a href=https://wiki.archlinux.org/title/Unified_kernel_image>unified kernel image</a> (UKI) that contains the kernel, initramfs, and microcode. This unified kernel image can then be signed with the keys created by sbctl.</p><p>For Fedora Workstation, you can follow <a href=https://haavard.name/2022/06/22/full-uefi-secure-boot-on-fedora-using-signed-initrd-and-systemd-boot/>Håvard Moen&rsquo;s guide</a> which covers sbctl installation, unified kernel image generation with <a href=https://wiki.archlinux.org/title/Dracut>dracut</a>, and automatic signing with systemd‑boot.</p><p>On Arch, the process is very similar, though sbctl is already included in the official repositories and you will need to switch from <a href=https://wiki.archlinux.org/title/Mkinitcpio>mkinitpcio</a> to dracut. Arch with linux‑hardened works well with sbctl, but some level of tedious pacman hooks are required for appropriately timing the re‑signing of all relevant files every time the kernel or bootloader is updated.</p><p>In my opinion, this is the most straightforward setup, with a lot of potential such as <a href=https://0pointer.de/blog/brave-new-trusted-boot-world.html>systemd&rsquo;s future UKI plans including support for early‑boot attestation</a>. With that being said, it does not appear to work well with specialized setups such as Fedora Silverblue/Kinoite or Ubuntu with <a href=https://github.com/ubuntu/zsys>ZSys</a>. More testing is needed to see if they can be made to work.</p><h3 id=encrypted-boot>Encrypted /boot<a hidden class=anchor aria-hidden=true href=#encrypted-boot>#</a></h3><h4 id=opensuse>openSUSE<a hidden class=anchor aria-hidden=true href=#opensuse>#</a></h4><p>openSUSE and its derivatives come with encrypted /boot out of the box (as part of the root partition). This setup does work, using encryption to sidestep the unverified initramfs problem.</p><p>However, there are some caveats:</p><ul><li>openSUSE uses LUKS1 instead of LUKS2 for encryption.</li><li>GRUB supports PBKDF2 key derivation only, not Argon2 (the LUKS2 default).</li><li>Some extra steps are necessary to <a href=https://en.opensuse.org/SDB:Encrypted_root_file_system#Avoiding_to_type_the_passphrase_twice_in_Leap_and_Tumbleweed>avoid typing the encryption password twice</a>.</li><li>Though rather tedious, you could potentially improve security by:<ul><li><a href=#enrolling-your-own-keys>Enrolling your own Secure Boot keys</a></li><li>Reinstalling GRUB with <code>--no-shim-lock</code></li><li>Signing GRUB and the kernel with your own keys</li><li>Removing shim and MOK from the boot chain</li><li>Setting up hooks to automate these tasks for every update</li></ul></li></ul><h4 id=other-distributions>Other Distributions<a hidden class=anchor aria-hidden=true href=#other-distributions>#</a></h4><p>On systems which use <a href=https://github.com/Antynea/grub-btrfs>grub‑btrfs</a> to mimic openSUSE (such as <a href=https://github.com/tommytran732/Arch-Setup-Script>my old Arch setup</a>), there are a few things to keep in mind:</p><ul><li>It will be easier to use LUKS1 than LUKS2 with PBKDF2 for this setup.<ul><li>I have run into issues where GRUB will detect a LUKS1 partition converted to LUKS2 with PBKDF2 but not a pre‑existing LUKS2 partition.</li></ul></li><li>Include /boot in your root partition instead of as a seperate partition.<ul><li>With a seperate /boot partition, an evil maid attack can theoretically replace it with a malicious /boot partition. Unlocking the drive through a fake decryption prompt on the malicious partition will subsequently compromise the rest of the system.</li></ul></li><li><a href=#enrolling-your-own-keys>Enroll your own Secure Boot keys</a></li><li>Install GRUB with the <code>--no-shim-lock</code> option. The full command I use on Arch is:<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB --modules=&#34;normal test efi_gop efi_uga search echo linux all_video gfxmenu gfxterm_background gfxterm_menu gfxterm loadenv configfile gzio part_gpt cryptodisk luks gcry_rijndael gcry_sha256 btrfs tpm&#34; --disable-shim-lock
</span></span></code></pre></div></li><li>Sign GRUB and the kernel with your own keys</li><li>Remove shim and MOK from the boot chain (if applicable)</li><li>Set up hooks to automate these tasks for every update (<a href=https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot#Signing_the_kernel_with_a_pacman_hook>pacman hooks for Arch</a>)</li><li>Disable the TPM from your firmware to prevent GRUB attempting <a href=https://www.gnu.org/software/grub/manual/grub/html_node/Measured-Boot.html>measured boot</a>, which <a href=https://github.com/Antynea/grub-btrfs/issues/156>does not work with grub-btrfs</a>.</li></ul><h3 id=notes-on-secure-boot>Notes on Secure Boot<a hidden class=anchor aria-hidden=true href=#notes-on-secure-boot>#</a></h3><p>After setting up Secure Boot, it is crucial that you password-protect your UEFI settings (sometimes called &lsquo;supervisor&rsquo; or &lsquo;administrator&rsquo; password) &mdash; otherwise an adversary can simply disable Secure Boot.</p><p>These recommendations can make you a little more resistant to evil maid attacks, but they <a href=https://madaidans-insecurities.github.io/guides/linux-hardening.html#verified-boot>do not constitute a proper verified boot process</a> as found on <a href=https://source.android.com/security/verifiedboot>Android</a>, <a href=https://support.google.com/chromebook/answer/3438631>ChromeOS</a>, or <a href=https://docs.microsoft.com/en-us/windows/security/information-protection/secure-the-windows-10-boot-process>Windows</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://loudrxiv.github.io/tags/operating-systems/>Operating Systems</a></li><li><a href=https://loudrxiv.github.io/tags/linux/>Linux</a></li><li><a href=https://loudrxiv.github.io/tags/privacy/>Privacy</a></li><li><a href=https://loudrxiv.github.io/tags/security/>Security</a></li></ul><nav class=paginav><a class=prev href=https://loudrxiv.github.io/posts/linux/choosing-your-desktop-linux-distribution/><span class=title>« Prev</span><br><span>Choosing Your Desktop Linux Distribution</span></a>
<a class=next href=https://loudrxiv.github.io/posts/linux/docker-and-oci-hardening/><span class=title>Next »</span><br><span>Docker and OCI Hardening</span></a></nav></footer></article></main><footer class=footer><span><a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a></span>
<span>- Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer">Hugo</a> &
        <a href=https://github.com/Wonderfall/hugo-WonderMod/ rel=noopener>WonderMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script defer crossorigin=anonymous src=/assets/js/papermod.7ea300eda6d3653624a576fbc095ccd8a0c2977756acbe5de4114132a72cc7fa.js integrity="sha256-fqMA7abTZTYkpXb7wJXM2KDCl3dWrL5d5BFBMqcsx/o="></script></body></html>