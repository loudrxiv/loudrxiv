<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using Split GPG and Split SSH on Qubes OS | PrivSec - A practical approach to Privacy and Security</title><meta name=keywords content="Operating Systems,Qubes OS,Security"><meta name=description content="This post will go over setting up Split GPG, then setting up Split SSH with the same PGP keys. Effectively, we are emulating what you can do with a PGP smartcard on Qubes OS.
Split GPG Follow the official Qubes OS documentation to set this up.
Note that if you already have a PGP key with a passphrase, you can remove it by installing pinentry-gtk to vault&rsquo;s TemplateVM, then do gpg2 --edit-key <key_id> and passwd to set an empty passphrase."><meta name=author content="Tommy"><link rel=canonical href=https://privsec.dev/posts/qubes/using-split-gpg-and-split-ssh-on-qubes-os/><link crossorigin=anonymous href=/assets/css/stylesheet.c5277e43fde8b6dabe803dff75b3c935ba15f1a218d18c0bcbaba3460636ce74.css integrity="sha256-xSd+Q/3ottq+gD3/dbPJNboV8aIY0YwLy6ujRgY2znQ=" rel="preload stylesheet" as=style><noscript><link crossorigin=anonymous href=/css/includes/noscript.30127fa68e36d08f5dd7f9d4e717dac42e729b844672afd0fbcacb0d9e508595.css integrity="sha256-MBJ/po420I9d1/nU5xfaxC5ym4RGcq/Q+8rLDZ5QhZU=" rel="preload stylesheet" as=style></noscript><link rel=icon href=https://privsec.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://privsec.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://privsec.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://privsec.dev/apple-touch-icon.png><link rel=mask-icon href=https://privsec.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta property="og:title" content="Using Split GPG and Split SSH on Qubes OS"><meta property="og:description" content="This post will go over setting up Split GPG, then setting up Split SSH with the same PGP keys. Effectively, we are emulating what you can do with a PGP smartcard on Qubes OS.
Split GPG Follow the official Qubes OS documentation to set this up.
Note that if you already have a PGP key with a passphrase, you can remove it by installing pinentry-gtk to vault&rsquo;s TemplateVM, then do gpg2 --edit-key <key_id> and passwd to set an empty passphrase."><meta property="og:type" content="article"><meta property="og:url" content="https://privsec.dev/posts/qubes/using-split-gpg-and-split-ssh-on-qubes-os/"><meta property="og:image" content="https://privsec.dev/privsec.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-13T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-04T16:21:06-05:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://privsec.dev/privsec.png"><meta name=twitter:title content="Using Split GPG and Split SSH on Qubes OS"><meta name=twitter:description content="This post will go over setting up Split GPG, then setting up Split SSH with the same PGP keys. Effectively, we are emulating what you can do with a PGP smartcard on Qubes OS.
Split GPG Follow the official Qubes OS documentation to set this up.
Note that if you already have a PGP key with a passphrase, you can remove it by installing pinentry-gtk to vault&rsquo;s TemplateVM, then do gpg2 --edit-key <key_id> and passwd to set an empty passphrase."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Categories","item":"https://privsec.dev/posts/"},{"@type":"ListItem","position":3,"name":"Qubes OS","item":"https://privsec.dev/posts/qubes/"},{"@type":"ListItem","position":4,"name":"Using Split GPG and Split SSH on Qubes OS","item":"https://privsec.dev/posts/qubes/using-split-gpg-and-split-ssh-on-qubes-os/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Split GPG and Split SSH on Qubes OS","name":"Using Split GPG and Split SSH on Qubes OS","description":"This post will go over setting up Split GPG, then setting up Split SSH with the same PGP keys. Effectively, we are emulating what you can do with a PGP smartcard on Qubes OS.\nSplit GPG Follow the official Qubes OS documentation to set this up.\nNote that if you already have a PGP key with a passphrase, you can remove it by installing pinentry-gtk to vault\u0026rsquo;s TemplateVM, then do gpg2 --edit-key \u0026lt;key_id\u0026gt; and passwd to set an empty passphrase.","keywords":["Operating Systems","Qubes OS","Security"],"articleBody":"This post will go over setting up Split GPG, then setting up Split SSH with the same PGP keys. Effectively, we are emulating what you can do with a PGP smartcard on Qubes OS.\nSplit GPG Follow the official Qubes OS documentation to set this up.\nNote that if you already have a PGP key with a passphrase, you can remove it by installing pinentry-gtk to vault’s TemplateVM, then do gpg2 --edit-key  and passwd to set an empty passphrase. The default non-graphical pinentry will just make an infinite loop and will not allow you to set an empty passphrase.\nSplit SSH This part is based on the Qubes Community’s guide; however, I will deviate from it to use the PGP keys for SSH instead of generating a new key pair.\nIn dom0  Create /etc/qubes-rpc/policy/qubes.SshAgent with @anyvm @anyvm ask,default_target=vault as the content. Since the keys ar not passphrase protected, you should not set the policy to allow.  In vault AppVM  Add enable-ssh-support to the end of ~/.gnupg/gpg-agent.conf Get your keygrip with gpg --with-keygrip -k Add your keygrip to the end of ~/.gnupg/sshcontrol  In vault’s TemplateVM  Create /etc/qubes-rpc/qubes.SshAgent with the following content:  #!/bin/sh # Qubes App Split SSH Script # Activate GPG Agent and set the correct SSH socket export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket) gpgconf --launch gpg-agent # safeguard - Qubes notification bubble for each ssh request notify-send \"[$(qubesdb-read /name)] SSH agent access from: $QREXEC_REMOTE_DOMAIN\" # SSH connection socat - \"UNIX-CONNECT:$SSH_AUTH_SOCK\"  Make it executable with sudo chmod +x /etc/qubes-rpc/qubes.SshAgent Turn off the templateVM. If the vault VM is running, turn it off, then start it to update the VM’s configuration.  In ssh-client AppVM  Add the following to the end of /rw/config/rc.local:  # SPLIT SSH CONFIGURATION  # replace \"vault\" with your AppVM name which stores the ssh private key(s) SSH_VAULT_VM=\"vault\" if [ \"$SSH_VAULT_VM\" != \"\" ]; then export SSH_SOCK=\"/home/user/.SSH_AGENT_$SSH_VAULT_VM\" rm -f \"$SSH_SOCK\" sudo -u user /bin/sh -c \"umask 177 \u0026\u0026 exec socat 'UNIX-LISTEN:$SSH_SOCK,fork' 'EXEC:qrexec-client-vm $SSH_VAULT_VMqubes.SshAgent'\" \u0026 fi #  Add the following to the end of ~/bash.rc:  # SPLIT SSH CONFIGURATION  # replace \"vault\" with your AppVM name which stores the ssh private key(s) SSH_VAULT_VM=\"vault\" if [ \"$SSH_VAULT_VM\" != \"\" ]; then export SSH_AUTH_SOCK=\"/home/user/.SSH_AGENT_$SSH_VAULT_VM\" fi #  Restart ssh-client and confirm if it’s working with ssh-add -L.  Limitations A malicious ssh-client AppVM can hold onto the ssh-agent connection for more than one use until it is shut down. While your private key is protected, a malicious actor with access to the AppVM can still abuse the ssh-agent to log into your servers.\n","wordCount":"427","inLanguage":"en","datePublished":"2022-08-13T00:00:00Z","dateModified":"2023-02-04T16:21:06-05:00","author":{"@type":"Person","name":"Tommy"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://privsec.dev/posts/qubes/using-split-gpg-and-split-ssh-on-qubes-os/"},"publisher":{"@type":"Organization","name":"PrivSec - A practical approach to Privacy and Security","logo":{"@type":"ImageObject","url":"https://privsec.dev/favicon.ico"}}}</script></head><body class=dark id=top><script crossorigin=anonymous src=/assets/js/theme.b20f95bb4da41ef90a2610a557a7000b2649a3f47282ec571676da6fc0427200.js integrity="sha256-sg+Vu02kHvkKJhClV6cACyZJo/RyguxXFnbab8BCcgA="></script><header class=header><div id=progressBar></div><nav class=nav><div class=logo><a href=https://privsec.dev accesskey=h title="PrivSec (Alt + H)"><img src=https://privsec.dev/privsec.png alt aria-label=logo height=30>PrivSec</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><input id=hamburger-input type=checkbox></input>
<label id=hamburger-menu for=hamburger-input></label><div class=overlay></div><ul id=menu><li><a href=https://privsec.dev/posts/ title=Categories><span>Categories</span></a></li><li><a href=https://privsec.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://privsec.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://privsec.dev/resources title=Resources><span>Resources</span></a></li><li><a href=https://tommytran.io/tommy.asc title=PGP><span>PGP</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://tommytran.io/tommy.crt title=S/MIME><span>S/MIME</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://privsec.dev>Home</a>&nbsp;»&nbsp;<a href=https://privsec.dev/posts/>Categories</a>&nbsp;»&nbsp;<a href=https://privsec.dev/posts/qubes/>Qubes OS</a></div><h1 class=post-title>Using Split GPG and Split SSH on Qubes OS</h1><div class=post-meta><span title='2022-08-13 00:00:00 +0000 UTC'>August 13, 2022</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;427 words&nbsp;·&nbsp;Tommy&nbsp;|&nbsp;<a href=https://github.com/PrivSec-dev/privsec.dev/blob/main/content/posts/qubes/Using%20Split%20GPG%20and%20Split%20SSH%20on%20Qubes%20OS.md rel="noopener noreferrer">Suggest Changes</a></div><div class=post-meta><span title="2023-02-04 16:21:06 -0500 EST"><i>Last updated on February 4, 2023</i></span></div></header><div class="toc side"><details id=toc><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#split-gpg aria-label="Split GPG">Split GPG</a></li><li><a href=#split-ssh aria-label="Split SSH">Split SSH</a><ul><li><a href=#in-dom0 aria-label="In dom0">In <code>dom0</code></a></li><li><a href=#in-vault-appvm aria-label="In vault AppVM">In <code>vault</code> AppVM</a></li><li><a href=#in-vaults-templatevm aria-label="In vault&amp;rsquo;s TemplateVM">In <code>vault</code>&rsquo;s TemplateVM</a></li><li><a href=#in-ssh-client-appvm aria-label="In ssh-client AppVM">In <code>ssh-client</code> AppVM</a></li><li><a href=#limitations aria-label=Limitations>Limitations</a></li></ul></li></ul></div></details></div><div class=post-content><p><img loading=lazy src=/images/split-gpg-ssh.png alt="Split GPG &amp;amp; SSH"></p><p>This post will go over setting up Split GPG, then setting up Split SSH with the same PGP keys. Effectively, we are emulating what you can do with a PGP smartcard on Qubes OS.</p><h2 id=split-gpg>Split GPG<a hidden class=anchor aria-hidden=true href=#split-gpg>#</a></h2><p>Follow the official Qubes OS <a href=https://www.qubes-os.org/doc/split-gpg/>documentation</a> to set this up.</p><p>Note that if you already have a PGP key with a passphrase, you can remove it by installing <code>pinentry-gtk</code> to <code>vault</code>&rsquo;s TemplateVM, then do <code>gpg2 --edit-key &lt;key_id></code> and <code>passwd</code> to set an empty passphrase. The default non-graphical pinentry will just make an infinite loop and will not allow you to set an empty passphrase.</p><h2 id=split-ssh>Split SSH<a hidden class=anchor aria-hidden=true href=#split-ssh>#</a></h2><p>This part is based on the Qubes Community&rsquo;s <a href=https://github.com/Qubes-Community/Contents/blob/master/docs/configuration/split-ssh.md>guide</a>; however, I will deviate from it to use the PGP keys for SSH instead of generating a new key pair.</p><h3 id=in-dom0>In <code>dom0</code><a hidden class=anchor aria-hidden=true href=#in-dom0>#</a></h3><ul><li>Create <code>/etc/qubes-rpc/policy/qubes.SshAgent</code> with <code>@anyvm @anyvm ask,default_target=vault</code> as the content. Since the keys ar not passphrase protected, you should <strong>not</strong> set the policy to allow.</li></ul><h3 id=in-vault-appvm>In <code>vault</code> AppVM<a hidden class=anchor aria-hidden=true href=#in-vault-appvm>#</a></h3><ul><li>Add <code>enable-ssh-support</code> to the end of <code>~/.gnupg/gpg-agent.conf</code></li><li>Get your keygrip with <code>gpg --with-keygrip -k</code></li><li>Add your keygrip to the end of <code>~/.gnupg/sshcontrol</code></li></ul><p><img loading=lazy src=/images/keygrip.png alt="PGP Keygrip"></p><h3 id=in-vaults-templatevm>In <code>vault</code>&rsquo;s TemplateVM<a hidden class=anchor aria-hidden=true href=#in-vaults-templatevm>#</a></h3><ul><li>Create <code>/etc/qubes-rpc/qubes.SshAgent</code> with the following content:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Qubes App Split SSH Script</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Activate GPG Agent and set the correct SSH socket</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>SSH_AUTH_SOCK</span><span class=o>=</span><span class=k>$(</span>gpgconf --list-dirs agent-ssh-socket<span class=k>)</span>
</span></span><span class=line><span class=cl>gpgconf --launch gpg-agent
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># safeguard - Qubes notification bubble for each ssh request</span>
</span></span><span class=line><span class=cl>notify-send <span class=s2>&#34;[</span><span class=k>$(</span>qubesdb-read /name<span class=k>)</span><span class=s2>] SSH agent access from: </span><span class=nv>$QREXEC_REMOTE_DOMAIN</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SSH connection</span>
</span></span><span class=line><span class=cl>socat - <span class=s2>&#34;UNIX-CONNECT:</span><span class=nv>$SSH_AUTH_SOCK</span><span class=s2>&#34;</span>
</span></span></code></pre></div><ul><li>Make it executable with <code>sudo chmod +x /etc/qubes-rpc/qubes.SshAgent</code></li><li>Turn off the templateVM. If the <code>vault</code> VM is running, turn it off, then start it to update the VM&rsquo;s configuration.</li></ul><h3 id=in-ssh-client-appvm>In <code>ssh-client</code> AppVM<a hidden class=anchor aria-hidden=true href=#in-ssh-client-appvm>#</a></h3><ul><li>Add the following to the end of <code>/rw/config/rc.local</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># SPLIT SSH CONFIGURATION &gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># replace &#34;vault&#34; with your AppVM name which stores the ssh private key(s)</span>
</span></span><span class=line><span class=cl><span class=nv>SSH_VAULT_VM</span><span class=o>=</span><span class=s2>&#34;vault&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$SSH_VAULT_VM</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>SSH_SOCK</span><span class=o>=</span><span class=s2>&#34;/home/user/.SSH_AGENT_</span><span class=nv>$SSH_VAULT_VM</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  rm -f <span class=s2>&#34;</span><span class=nv>$SSH_SOCK</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  sudo -u user /bin/sh -c <span class=s2>&#34;umask 177 &amp;&amp; exec socat &#39;UNIX-LISTEN:</span><span class=nv>$SSH_SOCK</span><span class=s2>,fork&#39; &#39;EXEC:qrexec-client-vm </span><span class=nv>$SSH_VAULT_VM</span><span class=s2> qubes.SshAgent&#39;&#34;</span> <span class=p>&amp;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=c1># &lt;&lt;&lt; SPLIT SSH CONFIGURATION</span>
</span></span></code></pre></div><ul><li>Add the following to the end of <code>~/bash.rc</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># SPLIT SSH CONFIGURATION &gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># replace &#34;vault&#34; with your AppVM name which stores the ssh private key(s)</span>
</span></span><span class=line><span class=cl><span class=nv>SSH_VAULT_VM</span><span class=o>=</span><span class=s2>&#34;vault&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$SSH_VAULT_VM</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>SSH_AUTH_SOCK</span><span class=o>=</span><span class=s2>&#34;/home/user/.SSH_AGENT_</span><span class=nv>$SSH_VAULT_VM</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=c1># &lt;&lt;&lt; SPLIT SSH CONFIGURATION</span>
</span></span></code></pre></div><ul><li>Restart <code>ssh-client</code> and confirm if it&rsquo;s working with <code>ssh-add -L</code>.</li></ul><h3 id=limitations>Limitations<a hidden class=anchor aria-hidden=true href=#limitations>#</a></h3><p>A malicious <code>ssh-client</code> AppVM can hold onto the ssh-agent connection for more than one use until it is shut down. While your private key is protected, a malicious actor with access to the AppVM can still abuse the ssh-agent to log into your servers.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://privsec.dev/tags/operating-systems/>Operating Systems</a></li><li><a href=https://privsec.dev/tags/qubes-os/>Qubes OS</a></li><li><a href=https://privsec.dev/tags/security/>Security</a></li></ul><nav class=paginav><a class=prev href=https://privsec.dev/posts/qubes/using-mullvad-vpn-on-qubes-os/><span class=title>« Prev</span><br><span>Using Mullvad VPN on Qubes OS</span></a></nav></footer></article></main><footer class=footer><span><a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a></span>
<span>- Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer">Hugo</a> &
        <a href=https://github.com/Wonderfall/hugo-WonderMod/ rel=noopener>WonderMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script defer crossorigin=anonymous src=/assets/js/papermod.7ea300eda6d3653624a576fbc095ccd8a0c2977756acbe5de4114132a72cc7fa.js integrity="sha256-fqMA7abTZTYkpXb7wJXM2KDCl3dWrL5d5BFBMqcsx/o="></script></body></html>