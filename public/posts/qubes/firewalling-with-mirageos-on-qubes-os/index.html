<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Firewalling with MirageOS on Qubes OS | PrivSec - A practical approach to Privacy and Security</title><meta name=keywords content="Operating Systems,MirageOS,Qubes OS,Security"><meta name=description content="MirageOS is a library operating system with which you can create a unikernel for the sole purpose of acting as Qubes OS&rsquo;s firewall. In this post, I will walk you through how to set this up.
Advantages  Small attack surface. The unikernel only contains a minimal set of libraries to function, so it has a much smaller attack surface than a general purpose operating system like a Linux distribution or openBSD."><meta name=author content="Tommy"><link rel=canonical href=https://privsec.dev/posts/qubes/firewalling-with-mirageos-on-qubes-os/><link crossorigin=anonymous href=/assets/css/stylesheet.c5277e43fde8b6dabe803dff75b3c935ba15f1a218d18c0bcbaba3460636ce74.css integrity="sha256-xSd+Q/3ottq+gD3/dbPJNboV8aIY0YwLy6ujRgY2znQ=" rel="preload stylesheet" as=style><noscript><link crossorigin=anonymous href=/css/includes/noscript.30127fa68e36d08f5dd7f9d4e717dac42e729b844672afd0fbcacb0d9e508595.css integrity="sha256-MBJ/po420I9d1/nU5xfaxC5ym4RGcq/Q+8rLDZ5QhZU=" rel="preload stylesheet" as=style></noscript><link rel=icon href=https://privsec.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://privsec.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://privsec.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://privsec.dev/apple-touch-icon.png><link rel=mask-icon href=https://privsec.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta property="og:title" content="Firewalling with MirageOS on Qubes OS"><meta property="og:description" content="MirageOS is a library operating system with which you can create a unikernel for the sole purpose of acting as Qubes OS&rsquo;s firewall. In this post, I will walk you through how to set this up.
Advantages  Small attack surface. The unikernel only contains a minimal set of libraries to function, so it has a much smaller attack surface than a general purpose operating system like a Linux distribution or openBSD."><meta property="og:type" content="article"><meta property="og:url" content="https://privsec.dev/posts/qubes/firewalling-with-mirageos-on-qubes-os/"><meta property="og:image" content="https://privsec.dev/privsec.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-04T16:21:06-05:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://privsec.dev/privsec.png"><meta name=twitter:title content="Firewalling with MirageOS on Qubes OS"><meta name=twitter:description content="MirageOS is a library operating system with which you can create a unikernel for the sole purpose of acting as Qubes OS&rsquo;s firewall. In this post, I will walk you through how to set this up.
Advantages  Small attack surface. The unikernel only contains a minimal set of libraries to function, so it has a much smaller attack surface than a general purpose operating system like a Linux distribution or openBSD."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Categories","item":"https://privsec.dev/posts/"},{"@type":"ListItem","position":3,"name":"Qubes OS","item":"https://privsec.dev/posts/qubes/"},{"@type":"ListItem","position":4,"name":"Firewalling with MirageOS on Qubes OS","item":"https://privsec.dev/posts/qubes/firewalling-with-mirageos-on-qubes-os/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Firewalling with MirageOS on Qubes OS","name":"Firewalling with MirageOS on Qubes OS","description":"MirageOS is a library operating system with which you can create a unikernel for the sole purpose of acting as Qubes OS\u0026rsquo;s firewall. In this post, I will walk you through how to set this up.\nAdvantages  Small attack surface. The unikernel only contains a minimal set of libraries to function, so it has a much smaller attack surface than a general purpose operating system like a Linux distribution or openBSD.","keywords":["Operating Systems","MirageOS","Qubes OS","Security"],"articleBody":"MirageOS is a library operating system with which you can create a unikernel for the sole purpose of acting as Qubes OS’s firewall. In this post, I will walk you through how to set this up.\nAdvantages  Small attack surface. The unikernel only contains a minimal set of libraries to function, so it has a much smaller attack surface than a general purpose operating system like a Linux distribution or openBSD. Low resource consumption. You only need about 64MB of RAM for each instance of the Mirage Firewall. Fast startup time.  Disadvantages  No official package for Qubes OS. This means that you need to follow the development process on GitHub and download the new build whenever there is a release. Does not work well with the Windows PV network driver. With that being said, the Windows PV networking driver is pretty buggy on its own, and I don’t recommend that you use it anyways.  Installing the unikernel To deploy MirageOS, you need to copy the vmlinuz and initramfs files from their releases page to /var/lib/qubes/vm-kernels/mirage-firewall in dom0.\nTemplateVM Create a TemplateVM:\nqvm-create \\  --property kernel=mirage-firewall \\  --property kernelopts='' \\  --property memory=64 \\  --property maxmem=64 \\  --property vcpus=1 \\  --property virt_mode=pvh \\  --label=black \\  --class TemplateVM \\  your_template_name Don’t worry if the TemplateVM doesn’t launch - we don’t need it to.\nDisposable Template Next, create a disposable template based on the TemplateVM you have just created.\nqvm-create \\  --property template=your_template_name \\  --property provides_network=True \\  --property template_for_dispvms=True \\  --label=orange \\  --class AppVM \\  your_disposable_template_name qvm-features your_disposable_template_name qubes-firewall 1 qvm-features your_disposable_template_name no-default-kernelopts 1 Your disposable templates should now launch and shutdown properly.\nDisposable FirewallVMs You can now create disposable FirewallVMs based on your disposable template. I recommend replacing sys-firewall with a disposable Mirage firewall. If you use ProxyVMs like sys-whonix, I recommend that you add a disposable Mirage Firewall after the ProxyVM as well, and use it as the net qube for your AppVMs.\nqvm-create \\  --property template=your_disposable_template_name \\  --property provides_network=True \\  --property netvm=your_net_qube_name \\  --label=orange \\  --class DispVM \\  your_firwall_name ","wordCount":"338","inLanguage":"en","datePublished":"2022-08-26T00:00:00Z","dateModified":"2023-02-04T16:21:06-05:00","author":{"@type":"Person","name":"Tommy"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://privsec.dev/posts/qubes/firewalling-with-mirageos-on-qubes-os/"},"publisher":{"@type":"Organization","name":"PrivSec - A practical approach to Privacy and Security","logo":{"@type":"ImageObject","url":"https://privsec.dev/favicon.ico"}}}</script></head><body class=dark id=top><script crossorigin=anonymous src=/assets/js/theme.b20f95bb4da41ef90a2610a557a7000b2649a3f47282ec571676da6fc0427200.js integrity="sha256-sg+Vu02kHvkKJhClV6cACyZJo/RyguxXFnbab8BCcgA="></script><header class=header><div id=progressBar></div><nav class=nav><div class=logo><a href=https://privsec.dev accesskey=h title="PrivSec (Alt + H)"><img src=https://privsec.dev/privsec.png alt aria-label=logo height=30>PrivSec</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><input id=hamburger-input type=checkbox></input>
<label id=hamburger-menu for=hamburger-input></label><div class=overlay></div><ul id=menu><li><a href=https://privsec.dev/posts/ title=Categories><span>Categories</span></a></li><li><a href=https://privsec.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://privsec.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://privsec.dev/resources title=Resources><span>Resources</span></a></li><li><a href=https://tommytran.io/tommy.asc title=PGP><span>PGP</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://tommytran.io/tommy.crt title=S/MIME><span>S/MIME</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://privsec.dev>Home</a>&nbsp;»&nbsp;<a href=https://privsec.dev/posts/>Categories</a>&nbsp;»&nbsp;<a href=https://privsec.dev/posts/qubes/>Qubes OS</a></div><h1 class=post-title>Firewalling with MirageOS on Qubes OS</h1><div class=post-meta><span title='2022-08-26 00:00:00 +0000 UTC'>August 26, 2022</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;338 words&nbsp;·&nbsp;Tommy&nbsp;|&nbsp;<a href=https://github.com/PrivSec-dev/privsec.dev/blob/main/content/posts/qubes/Firewalling%20with%20MirageOS%20on%20Qubes%20OS.md rel="noopener noreferrer">Suggest Changes</a></div><div class=post-meta><span title="2023-02-04 16:21:06 -0500 EST"><i>Last updated on February 4, 2023</i></span></div></header><div class="toc side"><details id=toc><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#advantages aria-label=Advantages>Advantages</a></li><li><a href=#disadvantages aria-label=Disadvantages>Disadvantages</a></li><li><a href=#installing-the-unikernel aria-label="Installing the unikernel">Installing the unikernel</a><ul><li><a href=#templatevm aria-label=TemplateVM>TemplateVM</a></li><li><a href=#disposable-template aria-label="Disposable Template">Disposable Template</a></li><li><a href=#disposable-firewallvms aria-label="Disposable FirewallVMs">Disposable FirewallVMs</a></li></ul></li></ul></div></details></div><div class=post-content><p><img loading=lazy src=/images/mirageos.png alt=MirageOS></p><p><a href=https://mirage.io/>MirageOS</a> is a library operating system with which you can create a unikernel for the sole purpose of acting as Qubes OS&rsquo;s firewall. In this post, I will walk you through how to set this up.</p><h2 id=advantages>Advantages<a hidden class=anchor aria-hidden=true href=#advantages>#</a></h2><ul><li>Small attack surface. The unikernel only contains a minimal set of libraries to function, so it has a much smaller attack surface than a general purpose operating system like a Linux distribution or openBSD.</li><li>Low resource consumption. You only need about 64MB of RAM for each instance of the Mirage Firewall.</li><li>Fast startup time.</li></ul><h2 id=disadvantages>Disadvantages<a hidden class=anchor aria-hidden=true href=#disadvantages>#</a></h2><ul><li>No official package for Qubes OS. This means that you need to follow the development process on GitHub and download the new build whenever there is a release.</li><li>Does not work well with the Windows PV network driver. With that being said, the Windows PV networking driver is pretty buggy on its own, and I don&rsquo;t recommend that you use it anyways.</li></ul><h2 id=installing-the-unikernel>Installing the unikernel<a hidden class=anchor aria-hidden=true href=#installing-the-unikernel>#</a></h2><p>To deploy MirageOS, you need to copy the <code>vmlinuz</code> and <code>initramfs</code> files from their <a href=https://github.com/mirage/qubes-mirage-firewall/releases>releases page</a> to <code>/var/lib/qubes/vm-kernels/mirage-firewall</code> in <code>dom0</code>.</p><h3 id=templatevm>TemplateVM<a hidden class=anchor aria-hidden=true href=#templatevm>#</a></h3><p>Create a TemplateVM:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qvm-create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>kernel</span><span class=o>=</span>mirage-firewall <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>kernelopts</span><span class=o>=</span><span class=s1>&#39;&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>memory</span><span class=o>=</span><span class=m>64</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>maxmem</span><span class=o>=</span><span class=m>64</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>vcpus</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>virt_mode</span><span class=o>=</span>pvh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --label<span class=o>=</span>black <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --class TemplateVM <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  your_template_name
</span></span></code></pre></div><p>Don&rsquo;t worry if the TemplateVM doesn&rsquo;t launch - we don&rsquo;t need it to.</p><h3 id=disposable-template>Disposable Template<a hidden class=anchor aria-hidden=true href=#disposable-template>#</a></h3><p>Next, create a disposable template based on the TemplateVM you have just created.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qvm-create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>template</span><span class=o>=</span>your_template_name <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>provides_network</span><span class=o>=</span>True <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>template_for_dispvms</span><span class=o>=</span>True <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --label<span class=o>=</span>orange <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --class AppVM <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  your_disposable_template_name
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>qvm-features your_disposable_template_name qubes-firewall <span class=m>1</span>
</span></span><span class=line><span class=cl>qvm-features your_disposable_template_name no-default-kernelopts <span class=m>1</span>
</span></span></code></pre></div><p>Your disposable templates should now launch and shutdown properly.</p><h3 id=disposable-firewallvms>Disposable FirewallVMs<a hidden class=anchor aria-hidden=true href=#disposable-firewallvms>#</a></h3><p>You can now create disposable FirewallVMs based on your disposable template. I recommend replacing <code>sys-firewall</code> with a disposable Mirage firewall. If you use ProxyVMs like <code>sys-whonix</code>, I recommend that you add a disposable Mirage Firewall after the ProxyVM as well, and use it as the net qube for your AppVMs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qvm-create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>template</span><span class=o>=</span>your_disposable_template_name <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>provides_network</span><span class=o>=</span>True <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --property <span class=nv>netvm</span><span class=o>=</span>your_net_qube_name <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --label<span class=o>=</span>orange <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --class DispVM <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  your_firwall_name
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://privsec.dev/tags/operating-systems/>Operating Systems</a></li><li><a href=https://privsec.dev/tags/mirageos/>MirageOS</a></li><li><a href=https://privsec.dev/tags/qubes-os/>Qubes OS</a></li><li><a href=https://privsec.dev/tags/security/>Security</a></li></ul><nav class=paginav><a class=next href=https://privsec.dev/posts/qubes/using-lokinet-on-qubes-os/><span class=title>Next »</span><br><span>Using Lokinet on Qubes OS</span></a></nav></footer></article></main><footer class=footer><span><a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a></span>
<span>- Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer">Hugo</a> &
        <a href=https://github.com/Wonderfall/hugo-WonderMod/ rel=noopener>WonderMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script defer crossorigin=anonymous src=/assets/js/papermod.7ea300eda6d3653624a576fbc095ccd8a0c2977756acbe5de4114132a72cc7fa.js integrity="sha256-fqMA7abTZTYkpXb7wJXM2KDCl3dWrL5d5BFBMqcsx/o="></script></body></html>